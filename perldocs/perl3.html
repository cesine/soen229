<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>perldocs page 3</title>
</head>
 <body text="#000000" bgcolor="#999999" link="#000099" vlink="#990099"
 alink="#000099">
  <a href="perl1.html">page 1</a><br>
 <a href="perl2.html">page 2</a><br>
 <a href="perl3.html">page 3</a><br>
 <a href="perl4.html">page 4</a><br>
   
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-11-SECT-5"></a> 
      <h3 class="docSection1Title">11.5 Reopening a Standard Filehandle</h3>
  
      <p class="docText">We mentioned earlier that if you were to reopen
a <a name="IXT-11-336397"></a>filehandle (that is, if you were to open a
filehandle <tt><font color="#cc0000">FRED</font></tt> when you've already
got an open filehandle named <tt><font color="#cc0000">FRED</font></tt>,
say), the old one would be closed for you automatically. And we said that
you shouldn't reuse one of the six standard filehandle names unless you intended
to get that one's special features. And we also said that the messages from 
      <tt><font color="#cc0000">die</font></tt> and <tt><font
 color="#cc0000">warn</font></tt>, along with Perl's internally generated
complaints, go automatically to <tt><font color="#cc0000">STDERR</font></tt><a
 name="IXT-11-336398"></a>. If you put those three pieces of information
together, you now have an idea about how you could send <a
 name="IXT-11-336399"></a>error messages to a file, rather than to your program's
standard error stream:<sup class="docFootnote"><a class="docLink"
 href="#">[19]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[19]</a></sup> Don't do this
without a reason. It's nearly always better to let the user set up redirection
when launching your program, rather than have redirection hardcoded. But
this is handy in cases where your program is being run automatically by another 
program (say, by a web server or a scheduling utility like <tt><font
 color="#cc0000">cron</font></tt> or <tt><font color="#cc0000">at</font></tt>).
Another reason might be that your program is going to start another process 
(probably with <tt><font color="#cc0000">system</font></tt> or <tt><font
 color="#cc0000">exec</font></tt>, which we'll see in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-14#lperl3-CHP-14">Chapter 14</a>),
and you need that process to have different I/O connections.</p>
      </blockquote>
  
      <pre><font color="#cc0000"># Send errors to my private error log<br>open STDERR, "&gt;&gt;/home/barney/.error_log"<br>  or die "Can't open error log for append: $!";</font></pre>
  
      <p class="docText">After reopening <tt><font color="#cc0000">STDERR</font></tt>,
any error messages from Perl will go into the new file. But what happens
if the <tt><font color="#cc0000">or die</font></tt> part is executed&#8212;where
will <span class="docEmphasis">that</span> message go, if the new file couldn't 
be opened to accept the messages? </p>
  
      <p class="docText">The answer is that if one of the three system filehandles&#8212;<tt><font
 color="#cc0000">STDIN</font></tt>, <tt><font color="#cc0000">STDOUT</font></tt>,
or <tt><font color="#cc0000">STDERR</font></tt>&#8212;fails to be reopened, Perl
kindly restores the original one.<sup class="docFootnote"><a
 class="docLink" href="#">[20]</a></sup> That is, Perl closes the original
one (of those three) only when it sees that opening the new connection is
successful. Thus, this technique could be used to redirect any (or all) of
those three system filehandles from inside your program,<sup
 class="docFootnote"><a class="docLink" href="#">[21]</a></sup> almost as
if the program had been run with that I/O redirection from the shell in the
first place.<a name="IXTR3-75"></a> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[20]</a></sup> At least, this
is true if you haven't changed Perl's special <tt><font color="#cc0000">$^F</font></tt>
variable, which tells Perl that only those three are special like this. But
you'd never change that.</p>
      </blockquote>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[21]</a></sup> But don't open 
        <tt><font color="#cc0000">STDIN</font></tt> for output or the others
for input. Just thinking about that makes our heads hurt.</p>
      </blockquote>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
 
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-11-SECT-6"></a> 
      <h3 class="docSection1Title">11.6 File Tests</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-794"></a>Now <a
 name="lperl3-IDXTERM-795"></a>you know how to open a filehandle for output.
Normally, that will create a new file, wiping out any existing file with
the same name. Perhaps you want to check that there isn't a file by that
name. Perhaps you need to know how old a given file is. Or perhaps you want
to go through a list of files to find which ones are larger than a certain
number of bytes and not accessed for a certain amount of time. Perl has a
complete set of tests you can use to find out information about files. </p>
  
      <p class="docText">Let's try that first example, where we need to check
that a given file doesn't exist, so that we don't accidentally overwrite
a vital spreadsheet data file, or that important birthday calendar. For this,
we need the <tt><font color="#cc0000">-e</font></tt> file test, testing for
existence: </p>
  
      <pre><font color="#cc0000">die "Oops! A file called '$filename' already exists.\n"<br>  if -e $filename;</font></pre>
  
      <p class="docText">Notice that we don't include <tt><font
 color="#cc0000">$!</font></tt> in this <tt><font color="#cc0000">die</font></tt>
message, since we're not reporting that the system refused a request in this
case. Here's an example of checking whether a file is being kept up-to-date. 
Let's say that our program's configuration file should be updated every week
or two. (Maybe it's checking for computer viruses, say.) If the file hasn't
been modified in the past 28 days, then something is wrong: </p>
  
      <pre><font color="#cc0000">warn "Config file is looking pretty old!\n"<br>  if -M CONFIG &gt; 28;</font></pre>
  
      <p class="docText">The third example is more complex. Here, let's say
that disk space is filling up and rather than buy more disks, we've decided
to move any large, useless files to the backup tapes. So let's go through
our list of files<sup class="docFootnote"><a class="docLink" href="#">[22]</a></sup>
to see which of them are larger than 100 K. But even if a file is large,
we shouldn't move it to the backup tapes unless it hasn't been accessed in
the last 90 days (so we know that it's not used too often):<sup
 class="docFootnote"><a class="docLink" href="#">[23]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[22]</a></sup> It's more likely
that, instead of having the list of files in an array, as our example shows,
you'll read it directly from the filesystem using a glob or directory handle,
as shown in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-12#lperl3-CHP-12">Chapter 12</a>.
Since we haven't seen that yet, we'll just start with the list and go from
there.</p>
      </blockquote>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[23]</a></sup> There's a way 
to make this example more efficient, as we'll see by the end of the chapter.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my @original_files = qw/ fred barney betty wilma pebbles dino bamm-bamm /;<br>my @big_old_files;  # The ones we want to put on backup tapes<br>foreach my $filename (@original_files) {<br>  push @big_old_files, $_<br>    if -s $filename &gt; 100_000 and -A $filename &gt; 90;<br>}</font></pre>
  
      <p class="docText">This is the first time that we've seen it, so maybe
you noticed that the control variable of the <tt><font color="#cc0000">foreach</font></tt>
loop is a <tt><font color="#cc0000">my</font></tt> variable. That declares
it to have the scope of the loop itself, so this example should work under
      <tt><font color="#cc0000">use strict</font></tt>. Without the <tt><font
 color="#cc0000">my</font></tt> keyword, this would be using the global <tt><font
 color="#cc0000">$filename</font></tt>. </p>
  
      <p class="docText">The file tests all look like a hyphen and a letter,
which is the name of the test, followed by either a filename or a filehandle
to be tested. Many of them return a true/false value, but several give something
more interesting. See <a class="docLink" href="#lperl3-CHP-11-TABLE-1">Table
11-1</a> for the complete list, and then read the following discussion to
learn more about the special cases. </p>
  <a name="lperl3-CHP-11-TABLE-1"></a>
      <p>
      <table border="1" cellspacing="0" cellpadding="1" width="100%">
 <caption>
        <h5 class="docTableTitle">Table 11-1. File tests and their meanings
        </h5>
        </caption><colgroup span="2"></colgroup><tbody>
          <tr>
 <th class="docTableHeader"> 
            <p class="docText">File test</p>
 </th>
 <th class="docTableHeader"> 
            <p class="docText">Meaning</p>
 </th>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-r</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText"><a name="IXT-11-336400"></a>File or directory
is readable by this (effective) user or group </p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-w</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText"><a name="IXT-11-336401"></a>File or directory
is writable by this (effective) user or group </p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-x</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory is executable by this (effective)
user or group</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-o</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory is owned by this (effective)
user</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-R</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory is readable by this real
user or group</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-W</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory is writable by this real
user or group</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-X</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory is executable by this real
user or group</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-O</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory is owned by this real user</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-e</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory name exists</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-z</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File exists and has zero size (always false
for directories)</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-s</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory exists and has nonzero size
(the value is the size in bytes) </p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-f</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Entry is a plain file</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-d</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Entry is a directory</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-l</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Entry is a symbolic link</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-S</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Entry is a socket</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-p</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Entry is a named pipe (a "fifo")</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-b</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Entry is a block-special file (like a mountable
disk)</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-c</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Entry is a character-special file (like an
I/O device)</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-u</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory is setuid</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-g</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory is setgid</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-k</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File or directory has the sticky bit set</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-t</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">The filehandle is a TTY (as reported by the
            <tt><font color="#cc0000">isatty( )</font></tt> system function;
filenames can't be tested by this test) </p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-T</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File looks like a "text" file</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-B</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">File looks like a "binary" file</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-M</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Modification age (measured in days)</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-A</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Access age (measured in days)</p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">-C</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Inode-modification age (measured in days)</p>
 </td>
 </tr>
  
        </tbody>
      </table>
      </p>
  
      <p class="docText">The tests <tt><font color="#cc0000">-r</font></tt>,
      <tt><font color="#cc0000">-w</font></tt>, <tt><font
 color="#cc0000">-x</font></tt>, and <tt><font color="#cc0000">-o</font></tt>
tell whether the given attribute is true for the effective user or group
ID,<sup class="docFootnote"><a class="docLink" href="#">[24]</a></sup> which
essentially refers to the person who is "in charge of" running the program.<sup
 class="docFootnote"><a class="docLink" href="#">[25]</a></sup> These tests
look at the "permission bits" on the file to see what is permitted. If your
system uses Access Control Lists (ACLs), the tests will use those as well.
These tests generally tell whether the system would <span
 class="docEmphasis">try</span> to permit something, but it doesn't mean
that it really would be possible. For example, <tt><font color="#cc0000">-w</font></tt>
may be true for a file on a CD-ROM, even though you can't write to it, or
      <tt><font color="#cc0000">-x</font></tt> may be true on an empty file,
which can't truly be executed. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[24]</a></sup> The <tt><font
 color="#cc0000">-o</font></tt> and <tt><font color="#cc0000">-O</font></tt>
tests relate only to the user ID and not to the group ID.</p>
      </blockquote>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[25]</a></sup> Note for advanced
students: the corresponding <tt><font color="#cc0000">-R</font></tt>, <tt><font
 color="#cc0000">-W</font></tt>, <tt><font color="#cc0000">-X</font></tt>,
and <tt><font color="#cc0000">-O</font></tt> tests use the real user or group
ID, which becomes important if your program may be running set-ID; in that 
case, it's generally the ID of the person who requested running it. See any
good book about advanced Unix programming for a discussion of set-ID programs.</p>
      </blockquote>
  
      <p class="docText">The <tt><font color="#cc0000">-s</font></tt> test
does return true if the file is nonempty, but it's a special kind of true.
It's the length of the file, measured in bytes, which evaluates as true for
a nonzero number. </p>
  
      <p class="docText">On a Unix filesystem,<sup class="docFootnote"><a
 class="docLink" href="#">[26]</a></sup> there are just seven types of items,
represented by the seven file tests <tt><font color="#cc0000">-f</font></tt>,
      <tt><font color="#cc0000">-d</font></tt>, <tt><font
 color="#cc0000">-l</font></tt>, <tt><font color="#cc0000">-S</font></tt>,
      <tt><font color="#cc0000">-p</font></tt>, <tt><font
 color="#cc0000">-b</font></tt>, and <tt><font color="#cc0000">-c</font></tt>.
Any item should be one of those. But if you have a <a
 name="IXT-11-336402"></a>symbolic link pointing to a file, that will report
true for both <tt><font color="#cc0000">-f</font></tt> and <tt><font
 color="#cc0000">-l</font></tt>. So if you want to know whether something
is a symbolic link, you should generally test that first. (We'll learn more
about symbolic links in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-13#lperl3-CHP-13">Chapter 13</a>.) 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[26]</a></sup> This is the
case on many non-Unix filesystems, but not all of the file tests are meaningful 
everywhere. For example, you aren't likely to have block special files on
your non-Unix system.</p>
      </blockquote>
  
      <p class="docText">The age tests, <tt><font color="#cc0000">-M</font></tt>,
      <tt><font color="#cc0000">-A</font></tt>, and <tt><font
 color="#cc0000">-C</font></tt> (yes, they're uppercase), return the number
of days since the file was last modified, accessed, or had its inode changed.<sup
 class="docFootnote"><a class="docLink" href="#">[27]</a></sup> (The inode
contains all of the information about the file except for its contents&#8212;see
the <tt><font color="#cc0000">stat</font></tt> system call manpage or a good
book on Unix internals for details.) This age value is a full floating-point
number, so you might get a value of <tt><font color="#cc0000">2.00001</font></tt>
if a file were modified two days and one second ago. (These "days" aren't
necessarily the same as a human would count; for example, if it's one thirty
in the morning when you check a file modified at about an hour before midnight,
the value of <tt><font color="#cc0000">-M</font></tt> for this file would
be around <tt><font color="#cc0000">0.1</font></tt>, even though it was modified 
"yesterday.") </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[27]</a></sup> This information
will be somewhat different on non-Unix systems, since not all keep track
of the same times that Unix does. For example, on some systems, the ctime
field (which the <tt><font color="#cc0000">-C</font></tt> test looks at)
is the file creation time (which Unix doesn't keep track of), rather than
the inode change time; see the <span class="docEmphasis">perlport</span>
manpage.</p>
      </blockquote>
  
      <p class="docText">When checking the age of a file, you might even
get a negative value like <tt><font color="#cc0000">-1.2</font></tt>, which
means that the file's last-access timestamp is set at about thirty hours
in the future! The zero point on this timescale is the moment your program
started running,<sup class="docFootnote"><a class="docLink" href="#">[28]</a></sup>
so that value might mean that a long-running program was looking at a file
that had just been accessed. Or a timestamp could be set (accidentally or
intentionally) to a time in the future. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[28]</a></sup> As recorded
in the <tt><font color="#cc0000">$^T</font></tt> variable, which you could
update (with a statement like <tt><font color="#cc0000">$^T = time;</font></tt>)
if you needed to get the ages relative to a different starting time.</p>
      </blockquote>
  
      <p class="docText">The tests <tt><font color="#cc0000">-T</font></tt>
and <tt><font color="#cc0000">-B</font></tt> take a try at telling whether
a file is text or binary. But people who know a lot about filesystems know
that there's no bit (at least in Unix-like operating systems) to indicate
that a file is a binary or text file&#8212;so how can Perl tell? The answer is
that Perl cheats: it opens the file, looks at the first few thousand bytes,
and makes an educated guess. If it sees a lot of null bytes, unusual control 
characters, and bytes with the high bit set, then that looks like a binary
file. If there's not much weird stuff then it looks like text. As you might
guess, it sometimes guesses wrong. If a text file has a lot of Swedish or
French words (which may have characters represented with the high bit set,
as some ISO-8859-something variant, or perhaps even a Unicode version), it
may fool Perl into declaring it binary. So it's not perfect, but if you just
need to separate your source code from compiled files, or HTML files from 
PNGs, these tests should do the trick. </p>
  
      <p class="docText">You'd think that <tt><font color="#cc0000">-T</font></tt>
and <tt><font color="#cc0000">-B</font></tt> would always disagree, since
a text file isn't a binary and vice versa, but there are two special cases 
where they're in complete agreement. If the file doesn't exist, both are
false, since it's neither a text file nor a binary. Alternatively, if the
file is empty, it's an empty text file and an empty binary file at the same
time, so they're both true. </p>
  
      <p class="docText">The <tt><font color="#cc0000">-t</font></tt> file
test returns true if the given filehandle is a TTY&#8212;in short, if it's able
to be interactive because it's not a simple file or pipe. When <tt><font
 color="#cc0000">-t STDIN</font></tt> returns true, it generally means that
you can interactively ask the user questions. If it's false, your program
is probably getting input from a file or pipe, rather than a keyboard. </p>
  
      <p class="docText">Don't worry if you don't know what some of the other
file tests mean&#8212;if you've never heard of them, you won't be needing them.
But if you're curious, get a good book about programming for <a
 name="IXT-11-336403"></a>Unix. (On non-Unix systems, these tests all try
to give results analogous to what they do on Unix. Usually you'll be able
to guess correctly what they'll do.) </p>
  
      <p class="docText">If you omit the filename or filehandle parameter
to a file test (that is, if you have just <tt><font color="#cc0000">-r</font></tt>
or just <tt><font color="#cc0000">-s</font></tt>, say), the default operand
is the file named in <tt><font color="#cc0000">$_</font></tt>.<sup
 class="docFootnote"><a class="docLink" href="#">[29]</a></sup> So, to test
a list of filenames to see which ones are readable, you simply type: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[29]</a></sup> The <tt><font
 color="#cc0000">-t</font></tt> file test is an exception; since that test
isn't useful with filenames (they're never TTYs). By default it tests <tt><font
 color="#cc0000">STDIN</font></tt>. </p>
      </blockquote>
  
      <pre><font color="#cc0000">foreach (@lots_of_filenames) {<br>  print "$_ is readable\n" if -r;  # same as -r $_<br>}</font></pre>
  
      <p class="docText">But if you omit the parameter, be careful that whatever
follows the file test doesn't look like it <span class="docEmphasis">could</span>
be a parameter. For example, if you wanted to find out the size of a file 
in K rather than in bytes, you might be tempted to divide the result of <tt><font
 color="#cc0000">-s</font></tt> by <tt><font color="#cc0000">1000</font></tt>
(or <tt><font color="#cc0000">1024</font></tt>), like this: </p>
  
      <pre><font color="#cc0000"># The filename is in $_<br>my $size_in_K = -s / 1000;  # Oops!</font></pre>
  
      <p class="docText">When the Perl parser sees the slash, it doesn't
think about division; since it's looking for the optional operand for <tt><font
 color="#cc0000">-s</font></tt>, it sees what looks like the start of a regular 
expression in forward slashes. One simple way to prevent this kind of confusion
is to put <a name="IXT-11-336404"></a>parentheses around the file test: </p>
  
      <pre><font color="#cc0000">my $size_in_k = (-s) / 1024;  # Uses $_ by default</font></pre>
  
      <p class="docText">Of course, it's always safe to explicitly give a
file test a parameter. </p>
  <a name="lperl3-CHP-11-SECT-6.1"></a> 
      <h4 class="docSection2Title">11.6.1 The stat and lstat Functions</h4>
  
      <p class="docText">While these file tests are fine for testing various
attributes regarding a particular file or filehandle, they don't tell the 
whole story. For example, there's no file test that returns the number of
links to a <a name="IXT-11-336405"></a>file or the owner's <a
 name="IXT-11-336406"></a> <a name="IXT-11-336407"></a>user-ID (uid). To
get at the remaining information about a file, merely call the <tt><font
 color="#cc0000">stat</font></tt><a name="IXT-11-336408"></a> function, which
returns pretty much everything that the stat Unix system call returns (hopefully
more than you want to know).<sup class="docFootnote"><a class="docLink"
 href="#">[30]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[30]</a></sup> On a non-Unix
system, both <tt><font color="#cc0000">stat</font></tt> and <tt><font
 color="#cc0000">lstat</font></tt>, as well as the file tests, should return
"the closest thing available." For example, a system that doesn't have user 
IDs (that is, a system that has just one "user," in the Unix sense) might
return zero for the user and group IDs, as if the one and only user is the
system administrator. If <tt><font color="#cc0000">stat</font></tt> or <tt><font
 color="#cc0000">lstat</font></tt> fails, it will return an empty list. If
the system call underlying a file test fails (or isn't available on the given
system), that test will generally return <tt><font color="#cc0000">undef</font></tt>.
See the <span class="docEmphasis">perlport</span> manpage for the latest
about what to expect on different systems.</p>
      </blockquote>
  
      <p class="docText">The operand to <tt><font color="#cc0000">stat</font></tt>
is a filehandle, or an expression that evaluates to a filename. The return
value is either the empty list, indicating that the <tt><font
 color="#cc0000">stat</font></tt> failed (usually because the file doesn't
exist), or a 13-element list of numbers, most easily described using the
following list of <a name="IXT-11-336409"></a>scalar variables: </p>
  
      <pre><font color="#cc0000">my($dev, $ino, $mode, $nlink, $uid, $gid, $rdev,<br>  $size, $atime, $mtime, $ctime, $blksize, $blocks)<br>    = stat($filename);</font></pre>
  
      <p class="docText">The names here refer to the parts of the stat structure,
described in detail in the <span class="docEmphasis">stat(2)</span><a
 name="IXT-11-336410"></a> manpage. You should probably look there for the
detailed descriptions. But in short, here's a quick summary of the important
ones: </p>
  <a name="IXT-11-336411"></a><a name="IXT-11-336412"></a>
      <dl class="docList">
        <dt><span class="docPubcolor"><span class="docPubcolor"><span
 class="docMonofont">$dev</span></span><a name="IXT-11-336411"></a> and <span
 class="docPubcolor"><span class="docMonofont">$ino</span></span><a
 name="IXT-11-336412"></a> </span></dt>
        <dd> 
          <p class="docList">The device number and inode number of the file.
Together they make up a "license plate" for the file. Even if it has more
than one name (hard link), the combination of device and inode numbers should
always be unique. </p>
 </dd>
      </dl>
  <a name="IXT-11-336413"></a>
      <dl class="docList">
        <dt><span class="docPubcolor"><span class="docPubcolor"><span
 class="docMonofont">$mode</span></span><a name="IXT-11-336413"></a></span></dt>
        <dd> 
          <p class="docList">The set of permission bits for the file, and
some other bits. If you've ever used the Unix command <i>ls -l</i> to get
a detailed (long) file listing, you'll see that each line of output starts
with something like <tt><font color="#cc0000">-rwxr-xr-x</font></tt>. The
nine letters and hyphens of file permissions<sup class="docFootnote"><a
 class="docLink" href="#">[31]</a></sup> correspond to the nine least-significant
bits of <tt><font color="#cc0000">$mode</font></tt>, which would in this
case give the octal number <tt><font color="#cc0000">0755</font></tt>. The
other bits, beyond the lowest nine, indicate other details about the file.
So if you need to work with the mode, you'll generally want to use the bitwise 
operators covered later in this chapter. </p>
 
          <blockquote>
            <p class="docFootnote"><sup><a name="">[31]</a></sup> The first
character in that string isn't a permission bit; it indicates the type of
entry: a hyphen for an ordinary file, <tt><font color="#cc0000">d</font></tt>
for directory, or <tt><font color="#cc0000">l</font></tt> for symbolic link,
among others. The <i>ls </i>command determines this from the other bits past
the least-significant nine. </p>
          </blockquote>
  </dd>
      </dl>
  <a name="IXT-11-336414"></a><a name="IXT-11-336415"></a>
      <dl class="docList">
        <dt><span class="docPubcolor"><span class="docPubcolor"><span
 class="docMonofont">$nlink</span></span><a name="IXT-11-336414"></a> <a
 name="IXT-11-336415"></a> </span></dt>
        <dd> 
          <p class="docList">The number of (hard) links to the file or directory.
This is the number of true names that the item has. This number is always 
          <tt><font color="#cc0000">2</font></tt> or more for directories
and (usually) <tt><font color="#cc0000">1</font></tt> for files. We'll see
more about this when we talk about creating links to files in <a
 class="docLink" href="?xmlid=0-596-00132-0/lperl3-CHP-13#lperl3-CHP-13">Chapter
13</a>. In the listing from <i>ls -l</i>, this is the number just after the
permission-bits string. </p>
 </dd>
      </dl>
  <a name="IXT-11-336416"></a><a name="IXT-11-336417"></a><a
 name="IXT-11-336418"></a><a name="IXT-11-336419"></a><a
 name="IXT-11-336420"></a>
      <dl class="docList">
        <dt><span class="docPubcolor"><span class="docPubcolor"><span
 class="docMonofont">$uid</span></span><a name="IXT-11-336416"></a> <a
 name="IXT-11-336417"></a> <a name="IXT-11-336418"></a> and<a
 name="IXT-11-336419"></a> <a name="IXT-11-336420"></a> <span
 class="docPubcolor"><span class="docMonofont">$gid</span></span></span></dt>
        <dd> 
          <p class="docList">The numeric user-ID and group-ID showing the
file's ownership.</p>
 </dd>
      </dl>
  <a name="IXT-11-336421"></a><a name="IXT-11-336422"></a>
      <dl class="docList">
        <dt><span class="docPubcolor"><span class="docPubcolor"><span
 class="docMonofont">$size</span></span><a name="IXT-11-336421"></a> <a
 name="IXT-11-336422"></a></span></dt>
        <dd> 
          <p class="docList">The size in bytes, as returned by the <tt><font
 color="#cc0000">-s</font></tt> file test.</p>
 </dd>
      </dl>
  <a name="IXT-11-336423"></a><a name="IXT-11-336424"></a><a
 name="IXT-11-336425"></a><a name="IXT-11-336426"></a><a
 name="IXT-11-336427"></a><a name="IXT-11-336428"></a>
      <dl class="docList">
        <dt><span class="docPubcolor"><span class="docPubcolor"><span
 class="docMonofont">$atime</span></span><a name="IXT-11-336423"></a> <a
 name="IXT-11-336424"></a> <a name="IXT-11-336425"></a>, <span
 class="docPubcolor"><span class="docMonofont">$mtime</span></span>, and
          <span class="docPubcolor"><span class="docMonofont">$ctime</span></span>
          </span></dt>
        <dd> 
          <p class="docList">The three <a name="IXT-11-336426"></a>timestamps,
but here they're represented in the system's timestamp format: a 32-bit number
telling how many seconds have passed since the <i>Epoch</i>, an arbitrary
starting point for measuring <a name="IXT-11-336427"></a>system time. On
Unix systems and some others, the <a name="IXT-11-336428"></a>Epoch is the
beginning of 1970 at midnight Universal Time, but the Epoch is different
on some machines. There's more information later in this chapter on turning
that timestamp number into something useful. </p>
 </dd>
      </dl>
  
      <p class="docText">Invoking <tt><font color="#cc0000">stat</font></tt>
on the name of a <a name="IXT-11-336429"></a>symbolic link returns information
on what the symbolic link points at, not information about the symbolic link
itself (unless the link just happens to be pointing at nothing currently
accessible). If you need the (mostly useless) information about the symbolic
link itself, use <tt><font color="#cc0000">lstat</font></tt><a
 name="IXT-11-336430"></a> rather than <tt><font color="#cc0000">stat</font></tt> 
(which returns the same information in the same order). If the operand isn't
a symbolic link, <tt><font color="#cc0000">lstat</font></tt> returns the
same things that <tt><font color="#cc0000">stat</font></tt> would. </p>
  
      <p class="docText">Like the file tests, the operand of <tt><font
 color="#cc0000">stat</font></tt> or <tt><font color="#cc0000">lstat</font></tt>
defaults to <tt><font color="#cc0000">$_</font></tt>, meaning that the underlying
stat system call will be performed on the file named by the scalar variable
      <tt><font color="#cc0000">$_</font></tt>. </p>
   <a name="lperl3-CHP-11-SECT-6.2"></a> 
      <h4 class="docSection2Title">11.6.2 The localtime Function</h4>
  
      <p class="docText">When you have a <a name="IXT-11-336431"></a> <a
 name="IXT-11-336432"></a>timestamp number (such as the ones from <tt><font
 color="#cc0000">stat</font></tt>), it will typically look something like 
1080630098. That's not very useful for most humans, unless you need to compare
two timestamps by subtracting. You may need to convert it to something human-readable,
such as a string like "<tt><font color="#cc0000">Tue Mar 30 07:01:38 2004</font></tt>".
Perl can do that with the <tt><font color="#cc0000">localtime</font></tt>
function in a scalar context: </p>
  
      <pre><font color="#cc0000">my $timestamp = 1080630098;<br>my $date = localtime $timestamp;</font></pre>
  
      <p class="docText">In a list context, <tt><font color="#cc0000">localtime</font></tt>
returns a list of numbers, several of which may not be quite what you'd expect: 
      </p>
  
      <pre><font color="#cc0000">my($sec, $min, $hour, $day, $mon, $year, $wday, $yday, $isdst)<br>  = localtime $timestamp;</font></pre>
  
      <p class="docText">The <tt><font color="#cc0000">$mon</font></tt> is
a month number, ranging from <tt><font color="#cc0000">0</font></tt> to <tt><font
 color="#cc0000">11</font></tt>, which is handy as an index into an array
of month names. The <tt><font color="#cc0000">$year</font></tt> is the number
of years since 1900, oddly enough, so add <tt><font color="#cc0000">1900</font></tt>
to get the real year number. The <tt><font color="#cc0000">$wday</font></tt>
ranges from <tt><font color="#cc0000">0</font></tt> (for Sunday) through
      <tt><font color="#cc0000">6</font></tt> (for Saturday), and the <tt><font
 color="#cc0000">$yday</font></tt> is the day-of-the-year (ranging from 0
for January 1, through 364 or 365 for December 31). </p>
  
      <p class="docText">There are two related functions that you'll also
find useful. The <tt><font color="#cc0000">gmtime</font></tt><a
 name="IXT-11-336433"></a> function is just the same as <tt><font
 color="#cc0000">localtime</font></tt>, except that it returns the time in 
      <a name="IXT-11-336434"></a>Universal Time (what we once called <a
 name="IXT-11-336435"></a>Greenwich Mean Time). If you need the current timestamp
number from the system clock, just use the <tt><font color="#cc0000">time</font></tt><a
 name="IXT-11-336436"></a> function. Both <tt><font color="#cc0000">localtime</font></tt>
and <tt><font color="#cc0000">gmtime</font></tt> default to using the current
      <tt><font color="#cc0000">time</font></tt> value if you don't supply
a parameter: </p>
  
      <pre><font color="#cc0000">my $now = gmtime;  # Get the current universal timestamp as a string</font></pre>
  
      <p class="docText">For more information on manipulating date and time
information, see the information about some useful modules in <a
 class="docLink" href="?xmlid=0-596-00132-0/lperl3-APP-B#lperl3-APP-B">Appendix
B</a>. </p>
   <a name="lperl3-CHP-11-SECT-6.3"></a> 
      <h4 class="docSection2Title">11.6.3 Bitwise Operators</h4>
  
      <p class="docText"><a name="lperl3-IDXTERM-833"></a>When you need to
work with numbers bit-by-bit, as when working with the mode bits returned
by <tt><font color="#cc0000">stat</font></tt>, you'll need to use the bitwise 
operators. The bitwise-and operator (<tt><font color="#cc0000">&amp;</font></tt>) 
reports which bits are set in the left argument <span
 class="docEmphasis">and</span> in the right argument. For example, the expression
      <tt><font color="#cc0000">10 &amp; 12</font></tt> has the value <tt><font
 color="#cc0000">8</font></tt>. The bitwise-and needs to have a one-bit in
both operands to produce a one-bit in the result. That means that the logical-and
operation on ten (which is <tt><font color="#cc0000">1010</font></tt> in binary)
and twelve (which is <tt><font color="#cc0000">1100</font></tt>) gives eight 
(which is <tt><font color="#cc0000">1000</font></tt>, with a one-bit only
where the left operand has a one-bit <span class="docEmphasis">and</span>
the right operand also has a one-bit). See <a class="docLink"
 href="#lperl3-CHP-11-FIG-1">Figure 11-1</a>. </p>
  
      <center> 
      <h5 class="docFigureTitle"><a name="lperl3-CHP-11-FIG-1"></a>Figure
11-1. Bitwise-and addition</h5>
 <img border="0" width="99" height="88" src="lrnp_1101.gif"
 alt="lrnp_1101.gif">
      </center>
  
      <p class="docText">The different bitwise operators and their meanings
are shown in this table: </p>
  <a name="ch11-9-fm2xml"></a>
      <p>
      <table border="1" cellspacing="0" cellpadding="1" width="100%">
 <colgroup span="2"></colgroup><tbody>
          <tr>
 <th class="docTableHeader"> 
            <p class="docText">Expression</p>
 </th>
 <th class="docTableHeader"> 
            <p class="docText">Meaning</p>
 </th>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">10 &amp; 12</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Bitwise-and&#8212;which bits are true in both operands
(this gives <tt><font color="#cc0000">8</font></tt>) </p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">10 | 12</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Bitwise-or&#8212;which bits are true in one operand
or the other (this gives <tt><font color="#cc0000">14</font></tt>) </p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">10 ^ 12</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Bitwise-xor&#8212;which bits are true in one operand
or the other but not both (this gives <tt><font color="#cc0000">6</font></tt>) 
            </p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">6 &lt;&lt; 2</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Bitwise shift left&#8212;shift the left operand
the number of bits shown by the right operand, adding zero-bits at the least-significant 
places (this gives <tt><font color="#cc0000">24</font></tt>) </p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">25 &gt;&gt; 2</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Bitwise shift right&#8212;shift the left operand
the number of bits shown by the right operand, discarding the least-significant
bits (this gives <tt><font color="#cc0000">6</font></tt>) </p>
 </td>
 </tr>
 <tr>
 <td class="docTableCell"> 
            <pre><font color="#cc0000">~ 10</font></pre>
 </td>
 <td class="docTableCell"> 
            <p class="docText">Bitwise negation, also called unary bit complement&#8212;return
the number with the opposite bit for each bit in the operand (this gives <tt><font
 color="#cc0000">0xFFFFFFF5</font></tt>, but see the text) </p>
 </td>
 </tr>
  
        </tbody>
      </table>
      </p>
  
      <p class="docText">So, here's an example of some things you could do
with the <tt><font color="#cc0000">$mode</font></tt> returned by <tt><font
 color="#cc0000">stat</font></tt>. The results of these bit manipulations
could be useful with <tt><font color="#cc0000">chmod</font></tt>, which we'll
see in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-13#lperl3-CHP-13">Chapter 13</a>:
 </p>
  
      <pre><font color="#cc0000"># $mode is the mode value returned from a stat of CONFIG<br>warn "Hey, the configuration file is world-writable!\n"<br>  if $mode &amp; 0002;                                # configuration security problem<br>my $classical_mode = 0777 &amp; $mode;                # mask off extra high-bits<br>my $u_plus_x = $classical_mode | 0100;            # turn one bit on<br>my $go_minus_r = $classical_mode &amp; (~ 0044);      # turn two bits off</font></pre>
   <a name="lperl3-CHP-11-SECT-6.4"></a> 
      <h4 class="docSection2Title">11.6.4 Using Bitstrings</h4>
  
      <p class="docText">All of the bitwise operators can work with <a
 name="IXT-11-336437"></a>bitstrings, as well as with integers. If the operands
are integers, the result will be an integer. (The integer will be at least
a 32-bit integer, but may be larger if your machine supports that. That is,
if you have a 64-bit machine, <tt><font color="#cc0000">~10</font></tt> may
give the 64-bit result <tt><font color="#cc0000">0xFFFFFFFFFFFFFFF5</font></tt>,
rather than the 32-bit result <tt><font color="#cc0000">0xFFFFFFF5</font></tt>.)
 </p>
  
      <p class="docText">But if any operand of a bitwise operator is a string,
Perl will perform the operation on that bitstring. That is, <tt><font
 color="#cc0000">"\xAA" | "\x55"</font></tt> will give the string <tt><font
 color="#cc0000">"\xFF"</font></tt>. Note that these values are single-byte
strings; the result is a byte with all eight bits set. Bitstrings may be
arbitrarily long. </p>
  
      <p class="docText">This is one of the very few places where Perl distinguishes
between strings and numbers. See the <span class="docEmphasis">perlop</span><a
 name="IXT-11-336438"></a> <a name="IXT-11-336439"></a> manpage for more
information on using bitwise operators on strings.<a name="IXTR3-76"></a> 
      </p>
   <a name="lperl3-CHP-11-SECT-6.5"></a> 
      <h4 class="docSection2Title">11.6.5 Using the Special Underscore Filehandle</h4>
  
      <p class="docText">Every time you use <tt><font color="#cc0000">stat</font></tt>, 
      <tt><font color="#cc0000">lstat</font></tt>, or a file test in a program,
Perl has to go out to the system to ask for a <a name="IXT-11-336440"></a> 
      <a name="IXT-11-336441"></a>stat buffer on the file (that is, the return
buffer from the stat system call). That means if you want to know whether
a file is both readable and writable, you've essentially asked the system
twice for the same information (which isn't likely to change in a fairly nonhostile
environment). </p>
  
      <p class="docText">This looks like a waste of time,<sup
 class="docFootnote"><a class="docLink" href="#">[32]</a></sup> and in fact,
it can be avoided. Doing a file test, <tt><font color="#cc0000">stat</font></tt><a
 name="IXT-11-336442"></a>, or <tt><font color="#cc0000">lstat</font></tt><a
 name="IXT-11-336443"></a> on the special <tt><font color="#cc0000">_</font></tt><a
 name="IXT-11-336444"></a> <a name="IXT-11-336445"></a> <a
 name="IXT-11-336446"></a> filehandle (that is, the operand is nothing but
a single underscore) tells Perl to use whatever happened to be lounging around
in memory from the previous file test, <tt><font color="#cc0000">stat</font></tt>,
or <tt><font color="#cc0000">lstat</font></tt> function, rather than going
out to the operating system again. Sometimes this is dangerous: a subroutine 
call can invoke <tt><font color="#cc0000">stat</font></tt> without your knowledge, 
blowing your buffer away. But if you're careful, you can save yourself a
few unneeded system calls, thereby making your program considerably faster.
Here's that example of finding files to put on the backup tapes again, using
the new tricks we've learned: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[32]</a></sup> Because it
is. Asking the system for information is relatively slow.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my @original_files = qw/ fred barney betty wilma pebbles dino bamm-bamm /;<br>my @big_old_files;                       # The ones we want to put on backup tapes<br>foreach (@original_files) {<br>  push @big_old_files, $_<br>    if (-s) &gt; 100_000 and -A _ &gt; 90;     # More efficient than before<br>}</font></pre>
  
      <p class="docText">Note that we used the default of <tt><font
 color="#cc0000">$_</font></tt> for the first test&#8212;this is no more efficient
(except perhaps for the programmer), but it gets the data from the operating
system. The second test uses the magic <tt><font color="#cc0000">_</font></tt>
filehandle; for this test, the data left around after getting the file's
size is used, which is exactly what we want. </p>
  
      <p class="docText">Note that testing the <tt><font color="#cc0000">_</font></tt>
filehandle is not the same as allowing the operand of a file test, <tt><font
 color="#cc0000">stat</font></tt>, or <tt><font color="#cc0000">lstat</font></tt>
to default to testing <tt><font color="#cc0000">$_</font></tt>; using <tt><font
 color="#cc0000">$_</font></tt> would be a fresh test each time on the current
file named by the contents of <tt><font color="#cc0000">$_</font></tt>, but
using <tt><font color="#cc0000">_</font></tt> saves the trouble of calling
the system again. Here is another case where similar names were chosen for
radically different functions. By now, you are probably used to<a
 name="IXTR3-77"></a> it.<a name="IXTR3-78"></a> </p>
    <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
 
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-11-SECT-7"></a> 
      <h3 class="docSection1Title">11.7 Exercises</h3>
  
      <p class="docText">See <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-APP-A-SECT-10#lperl3-APP-A-SECT-10">Section
A.10</a> for answers to the following exercises: </p>
  <span style="font-weight: bold;">
      <ol class="docList" type="1">
 <li><span style="font-weight: normal;">
          <p class="docList">[20] Make a program which asks the user for
a source file name, a destination file name, a search pattern, and a replacement
string. (Be sure to ask the user interactively for these; don't get them
from the command-line arguments.) Your program should read the source file
and write it out as the destination file, replacing the search pattern with
the replacement string wherever it appears. That is, the destination file
will be a modified duplicate of the source file. Can you overwrite an existing
file (not the same as the input file)? Can you use regular expression metacharacters
in the search pattern? (That is, can you enter <tt><font color="#cc0000">(fred|wilma) 
flintstone</font></tt> to search for either name?) Can you use the memory
variables and backslash escapes in the replacement string? (That is, can
you use <tt><font color="#cc0000">\u\L$1\E Flintstone</font></tt> as the replacement
string to properly capitalize the names of Fred and Wilma?) Don't worry if
you can't accomplish each of these things; it's more important simply to
see what happens when you try. </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[15] Make a program which takes a list of files
named on the command line and reports for each one whether it's readable,
writable, executable, or doesn't exist. (Hint: It may be helpful to have a
function which will do all of the file tests for one file at a time.) What
does it report about a file which has been <i>chmod</i>'ed to <tt><font
 color="#cc0000">0</font></tt>? (That is, if you're on a Unix system, use
the command <i>chmod 0 some_file</i> to mark that file as neither being readable, 
writable, nor executable.) In most shells, use a star as the argument to
mean all of the normal files in the current directory. That is, you could
type something like <tt><font color="#cc0000">./ex11-2 *</font></tt> to ask 
the program for the attributes of many files at once. </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[10] Make a program to identify the oldest file
named on the command line and report its age in days. What does it do if
the list is empty? (That is, if no files are mentioned on the command line.) 
          </p>
          </span></li>
 
      </ol>
      </span>  <a href="?xmlid=0-596-00132-0/18961533"><img
 src="images/pixel.gif" width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
 
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-12"></a>  
      <h2 class="docChapterTitle">Chapter 12. Directory Operations</h2>
  
      <p class="docText"><a name="lperl3-IDXTERM-847"></a>The files we created
in the previous chapter were generally in the same place as our program.
But modern operating systems let us organize files into directories, allowing
us to keep our Beatles MP3s away from our important Llama book chapter sources
so that we don't accidentally send an MP3 file to the publisher. Perl lets
you manipulate these directories directly, in ways that are even fairly portable
from one operating system to another. </p>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
 
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-12-SECT-1"></a> 
      <h3 class="docSection1Title">12.1 Moving Around the Directory Tree</h3>
  
      <p class="docText">Your program runs with a "working directory," which
is the starting point for relative pathnames. That is, if you refer to the
file <tt><font color="#cc0000">fred</font></tt>, that means "<tt><font
 color="#cc0000">fred</font></tt> in the current working directory." </p>
  
      <p class="docText">The <tt><font color="#cc0000">chdir</font></tt><a
 name="IXT-12-336447"></a> operator changes the <a name="IXT-12-336448"></a>working
directory. It's just like the Unix shell's <a name="IXT-12-336449"></a><i>cd</i>
command: </p>
  
      <pre><font color="#cc0000">chdir "/etc" or die "cannot chdir to /etc: $!";</font></pre>
  
      <p class="docText">Because this is a system request, the value of <tt><font
 color="#cc0000">$!</font></tt> will be set if an error occurs. You should
normally check <tt><font color="#cc0000">$!</font></tt> when a false value
is returned from <tt><font color="#cc0000">chdir</font></tt>, since that
indicates that something has not gone as requested. </p>
  
      <p class="docText">The working directory is inherited by all processes
that Perl starts (we'll talk more about that in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-14#lperl3-CHP-14">Chapter 14</a>). 
However, the change in working directory cannot affect the process that invoked
Perl, such as the shell.<sup class="docFootnote"><a class="docLink"
 href="#">[1]</a></sup> So you can't make a Perl program to replace your
shell's <i>cd</i> command. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[1]</a></sup> This isn't a
limitation on Perl's part; it's actually a feature of Unix, Windows, and
other systems. If you really need to change the shell's working directory,
see the documentation of your shell. </p>
      </blockquote>
  
      <p class="docText">If you omit the parameter, Perl determines your <a
 name="IXT-12-336450"></a>home directory as best as possible and attempts
to set the working directory to your home directory, similar to using the 
      <i>cd</i> command at the shell without a parameter. This is one of
the few places where omitting the parameter doesn't use <tt><font
 color="#cc0000">$_</font></tt>. </p>
  
      <p class="docText">Some shells permit you to use a tilde-prefixed path
with <i>cd</i> to use another user's home directory as a starting point (like
      <tt><font color="#cc0000">cd</font></tt> <tt><font color="#cc0000">~merlyn</font></tt>).
This is a function of the shell, not the operating system, and Perl is calling
the operating system directly. Thus, a <a name="IXT-12-336451"></a> <a
 name="IXT-12-336452"></a>tilde-prefix will not work with <tt><font
 color="#cc0000">chdir</font></tt>. </p>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
 
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-12-SECT-2"></a> 
      <h3 class="docSection1Title">12.2 Globbing</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-854"></a>Normally, the shell
expands any filename patterns on each command line into the matching filenames.
This is called <span class="docEmphasis">globbing</span>. For example, if
you give a filename pattern of <tt><font color="#cc0000">*.pm</font></tt>
to the <i>echo</i><a name="IXT-12-336453"></a> command, the shell expands
this list to a list of names that match: </p>
  
      <pre><font color="#cc0000">$ <b>echo *.pm</b>
barney.pm dino.pm fred.pm wilma.pm
$</font></pre>
  
      <p class="docText">The <span class="docEmphasis">echo</span> command
doesn't have to know anything about expanding <tt><font color="#cc0000">*.pm</font></tt>,
because the shell has already expanded it. This works even for your Perl
programs: </p>
  
      <pre><font color="#cc0000">$ <b>cat &gt;show-args</b>
<b>foreach $arg (@ARGV) {</b>
<b>  print "one arg is $arg\n";</b>
<b>}</b>
<b>^D</b>
$ <b>perl show-args *.pm</b>
one arg is barney.pm
one arg is dino.pm
one arg is fred.pm
one arg is wilma.pm
$</font></pre>
  
      <p class="docText">Note that <i>show-args</i> didn't need to know anything
about globbing&#8212;the names were already expanded in <tt><font
 color="#cc0000">@ARGV</font></tt>. </p>
  
      <p class="docText">But sometimes we end up with a pattern like <tt><font
 color="#cc0000">*.pm</font></tt> inside our Perl program. Can we expand
this pattern into the matching filenames without working very hard? Sure&#8212;just
use the <tt><font color="#cc0000">glob</font></tt><a
 name="IXT-12-336454"></a> operator: </p>
  
      <pre><font color="#cc0000">my @all_files = glob "*";<br>my @pm_files = glob "*.pm";</font></pre>
  
      <p class="docText">Here, <tt><font color="#cc0000">@all_files</font></tt>
gets all the files in the current directory, alphabetically sorted, and not
including the files beginning with a period, just like the shell. And <tt><font
 color="#cc0000">@pm_files</font></tt> gets the same list as we got before
by using <tt><font color="#cc0000">*.pm</font></tt> on the command line. </p>
  
      <p class="docText">In fact, anything you can say on the command line,
you can also put as the (single) argument to <tt><font color="#cc0000">glob</font></tt>,
including multiple patterns separated by spaces: </p>
  
      <pre><font color="#cc0000">my @all_files_including_dot = glob ".* *";</font></pre>
  
      <p class="docText">Here, we've included an additional "dot star" parameter
to get the filenames that begin with a dot as well as the ones that don't.
Please note that the space between these two items inside the quoted string
is significant, as it separates two different items to be globbed.<sup
 class="docFootnote"><a class="docLink" href="#">[2]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[2]</a></sup> Windows users
may be accustomed to using a glob of *.* to mean "all files". But that actually
means "all files with a dot in their names," even in Perl on Windows.</p>
      </blockquote>
  
      <p class="docText">The reason this works exactly as the shell works
is that prior to Perl Version 5.6, the <tt><font color="#cc0000">glob</font></tt>
operator simply called <span class="docEmphasis">/bin/csh</span><sup
 class="docFootnote"><a class="docLink" href="#">[3]</a></sup> behind the
scenes to perform the expansion. Because of this, globs were time-consuming
and could break in large directories, or in some other cases. Conscientious
Perl hackers avoided globbing in favor of directory handles, which will be
discussed in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-12-SECT-4#lperl3-CHP-12-SECT-4">Section
12.4</a> later in this chapter. However, if you're using a modern version
of Perl, you should no longer be concerned about such things. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[3]</a></sup> Or it will call 
a valid substitute if a C-shell wasn't available.</p>
      </blockquote>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-12-SECT-3"></a> 
      <h3 class="docSection1Title">12.3 An Alternate Syntax for Globbing</h3>
  
      <p class="docText">Although we use the term globbing freely, and we
talk about the <tt><font color="#cc0000">glob</font></tt> operator, you might
not see the word <tt><font color="#cc0000">glob</font></tt> in very many
of the programs that use globbing. Why not? Well, most legacy code was written
before the <tt><font color="#cc0000">glob</font></tt> operator was given
a name. Instead, it was called up by the <a name="IXT-12-336455"></a> <a
 name="IXT-12-336456"></a>angle-bracket syntax, similar to reading from a
filehandle: </p>
  
      <pre><font color="#cc0000">my @all_files = &lt;*&gt;; ## exactly the same as my @all_files = glob "*";</font></pre>
  
      <p class="docText">The value between the angle brackets is interpolated
similar to a double-quoted string, which means that Perl variables are expanded
to their current Perl values before being globbed: </p>
  
      <pre><font color="#cc0000">my $dir = "/etc";<br>my @dir_files = &lt;$dir/* $dir/.*&gt;;</font></pre>
  
      <p class="docText">Here, we've fetched all the non-dot and dot files
from the designated directory, because <tt><font color="#cc0000">$dir</font></tt>
has been expanded to its current value. </p>
  
      <p class="docText">So, if using angle brackets means both filehandle
reading and <a name="IXT-12-336457"></a> <a name="IXT-12-336458"></a>globbing,
how does Perl decide which of the two operators to use? Well, a filehandle
has to be a Perl identifier. So if the item between the angle brackets is
strictly a Perl identifier, it's a filehandle read; otherwise, it's a globbing
operation. For example: </p>
  
      <pre><font color="#cc0000">my @files = &lt;FRED/*&gt;;   ## a glob<br>my @lines = &lt;FRED&gt;;    ## a filehandle read<br>my $name = "FRED";<br>my @files = &lt;$name/*&gt;; ## a glob</font></pre>
  
      <p class="docText">The one exception is if the contents are a simple
scalar variable (not an element of a hash or array), then it's an <i>indirect
filehandle read</i><a name="IXT-12-336459"></a><span class="docEmphasis">,<sup
 class="docFootnote"><a class="docLink" href="#">[4]</a></sup></span> where
the variable contents give the name of the filehandle to be read: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[4]</a></sup> If the indirect 
handle is a text string, then it's subject to the "symbolic reference" test
that is forbidden under <tt><font color="#cc0000">use strict</font></tt>.
However, the indirect handle might also be a typeglob or reference to an
IO object, and then it would work even under <tt><font color="#cc0000">use
strict</font></tt>.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my $name = "FRED";<br>my @lines = &lt;$name&gt;; ## an indirect filehandle read of FRED handle</font></pre>
  
      <p class="docText">Determining whether it's a glob or a filehandle
read is made at compile time, and thus it is independent of the content of
the variables. </p>
  
      <p class="docText">If you want, you can get the operation of an indirect
filehandle read using the <tt><font color="#cc0000">readline</font></tt>
operator,<sup class="docFootnote"><a class="docLink" href="#">[5]</a></sup>
which also makes it clearer: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[5]</a></sup> If you're using
Perl 5.005 or later.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my $name = "FRED";<br>my @lines = readline FRED;  ## read from FRED<br>my @lines = readline $name; ## read from FRED</font></pre>
  
      <p class="docText">But the <tt><font color="#cc0000">readline</font></tt><a
 name="IXT-12-336460"></a> operator is rarely used, as indirect filehandle
reads are uncommon and are generally performed against a simple scalar variable
anyway.<a name="IXTR3-79"></a> </p>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-12-SECT-4"></a> 
      <h3 class="docSection1Title">12.4 Directory Handles</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-864"></a>Another way to
get a list of names from a given directory is with a <span
 class="docEmphasis">directory handle</span>. A directory handle looks and
acts like a filehandle. You open it (with <tt><font color="#cc0000">opendir</font></tt><a
 name="IXT-12-336461"></a> instead of <tt><font color="#cc0000">open</font></tt>), 
you read from it (with <tt><font color="#cc0000">readdir</font></tt><a
 name="IXT-12-336462"></a> instead of <tt><font color="#cc0000">readline</font></tt>),
and you close it (with <tt><font color="#cc0000">closedir</font></tt><a
 name="IXT-12-336463"></a> instead of <tt><font color="#cc0000">close</font></tt>).
But instead of reading the <span class="docEmphasis">contents</span> of a
file, you're reading the <span class="docEmphasis">names</span> of <a
 name="IXT-12-336464"></a>files (and other things) in a directory. For example: 
      </p>
  
      <pre><font color="#cc0000">my $dir_to_process = "/etc";<br>opendir DH, $dir or die "Cannot open $dir: $!";<br>foreach $file (readdir DH) {<br>  print "one file in $dir is $file\n";<br>}<br>closedir DH;</font></pre>
  
      <p class="docText">Like filehandles, directory handles are automatically
closed at the end of the program or if the directory handle is reopened onto 
another directory. </p>
  
      <p class="docText">Unlike <a name="IXT-12-336465"></a>globbing, which
in older versions of Perl fired off a separate process, a directory handle
never fires off another process. So it makes them more efficient for applications 
that demand every ounce of power from the machine. However, it's also a lower-level
operation, meaning that we have to do more of the work ourselves. </p>
  
      <p class="docText">For example, the names are returned in no particular
order.<sup class="docFootnote"><a class="docLink" href="#">[6]</a></sup>
And the list includes all files, not just those matching a particular pattern 
(like <tt><font color="#cc0000">*.pm</font></tt> from our globbing examples).
And the list includes all files, especially the dot files, and particularly 
the dot and dot-dot entries.<sup class="docFootnote"><a class="docLink"
 href="#">[7]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[6]</a></sup> It's actually
the unsorted order of the directory entries, similar to the order you get
from <i>ls -f </i>or <i>find</i>.</p>
      </blockquote>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[7]</a></sup> Do not make
the mistake of many old Unix programs and presume that dot and dot-dot are
always returned as the first two entries (sorted or not). If that hadn't
even occurred to you, pretend we never said it, because it's a false presumption.
In fact, we're now sorry for even bringing it up.</p>
      </blockquote>
  
      <p class="docText">So, if we wanted only the <span
 class="docEmphasis">pm</span>-ending files, we could use a skip-over function
inside the loop: </p>
  
      <pre><font color="#cc0000">while ($name = readdir DIR) {<br>  next unless $name =~ /\.pm$/;<br>  ... more processing ...<br>}</font></pre>
  
      <p class="docText">Note here that the syntax is that of a regular expression,
not a glob. And if we wanted all the non-dot files, we could say that: </p>
  
      <pre><font color="#cc0000">next if $name =~ /^\./;</font></pre>
  
      <p class="docText">Or if we wanted everything but the common dot (current
directory) and dot-dot (parent directory) entries, we could explicitly say
that: </p>
  
      <pre><font color="#cc0000">next if $name eq "." or $name eq "..";</font></pre>
  
      <p class="docText">Now we'll look at the part that gets most people
mixed up, so pay close attention. The filenames returned by the <tt><font
 color="#cc0000">readdir</font></tt> operator have <span
 class="docEmphasis">no</span> pathname component. It's just the <span
 class="docEmphasis">name</span> within the directory. So, we're not looking
at <span class="docEmphasis">/etc/passwd</span>, we're just looking at <span
 class="docEmphasis">passwd</span>. (And because this is another difference 
from the globbing operation, it's easy to see how people get confused.) </p>
  
      <p class="docText">So you'll need to patch up the name to get the full
name:</p>
  
      <pre><font color="#cc0000">opendir SOMEDIR, $dirname or die "Cannot open $dirname: $!";<br>while (my $name = readdir SOMEDIR) {<br>  next if $name =~ /^\./; # skip over dot files<br>  $name = "$dirname/$name"; # patch up the path<br>  next unless -f $name and -r $name; # only readable files<br>  ...<br>}</font></pre>
  
      <p class="docText">Without the patch, the file tests would have been
checking files in the current directory, rather than in the directory named
in <tt><font color="#cc0000">$dirname</font></tt>. This is the single most-common
mistake when using directory handles.<a name="IXTR3-80"></a> </p>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-12-SECT-5"></a> 
      <h3 class="docSection1Title">12.5 Recursive Directory Listing</h3>
  
      <p class="docText">You probably won't need <a name="IXT-12-336466"></a>recursive
directory access for the first few dozen hours of your Perl programming career.
So rather than distract you with the possibility of replacing all those ugly 
      <i>find</i> scripts with Perl right now, we'll simply entice you by
saying that Perl comes with a nice library called<a name="IXT-12-336467"></a> 
      <tt><font color="#cc0000">File::Find</font></tt>, which you can use
for nifty recursive directory processing. We're also saying this to keep
you from writing your own routines, which everyone seems to want to do after 
those first few dozen hours of programming, and then getting puzzled about
things like "local directory handles" and "how do I change my directory back?"
So, when you're ready, the knowledge will come, but stay with us to learn
about Manipulating Files and Directories (in the next chapter) instead, right
after you finish these exercises.<a name="IXTR3-81"></a> </p>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-12-SECT-6"></a> 
      <h3 class="docSection1Title">12.6 Exercises</h3>
  
      <p class="docText">See <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-APP-A-SECT-11#lperl3-APP-A-SECT-11">Section
A.11</a> for answers to the following exercises. </p>
  <span style="font-weight: bold;">
      <ol class="docList" type="1">
 <li><span style="font-weight: normal;">
          <p class="docList">[12] Write a program to ask the user for a directory
name, then change to that directory. If the user enters a line with nothing
but whitespace, change to his or her home directory as a default. After changing,
list the ordinary directory contents (not the items whose names begin with
a dot) in alphabetical order. (Hint: Will that be easier to do with a directory
handle or with a glob?) If the directory change doesn't succeed, just alert
the user&#8212;but don't try show the contents. </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[4] Modify the program to include all files,
not just the ones that don't begin with a dot. </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[5] If you used a directory handle for the previous
exercise, rewrite it to use a glob. Or if you used a glob, try it now with
a directory handle. </p>
          </span></li>
 
      </ol>
      </span>  <a href="?xmlid=0-596-00132-0/18961533"><img
 src="images/pixel.gif" width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13"></a>  
      <h2 class="docChapterTitle">Chapter 13. Manipulating Files and Directories</h2>
  
      <p class="docText"><a name="lperl3-IDXTERM-874"></a>Perl is commonly
used to wrangle files and directories. Because Perl grew up in a Unix environment
and still spends most of its time there, most of the description in this
chapter may seem Unix-centric. But the nice thing is that to whatever degree
possible, Perl works exactly the same way on non-Unix systems. </p>
  
      <p class="docText">And now a word of warning&#8212;some cultures consider
the number "13" to be very unlucky. We deliberately placed this material
as <a class="docLink" href="#lperl3-CHP-13">Chapter 13</a> of this book,
since we're about to do some pretty dangerous things if bugs creep into the
code (like remove files without a chance of recovery), so be very careful
when you're playing with the exercises. </p>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13-SECT-1"></a> 
      <h3 class="docSection1Title">13.1 Removing Files</h3>
  
      <p class="docText">Most of the time, we make <a
 name="IXT-13-336468"></a> <a name="IXT-13-336469"></a>files so that the
data can stay around for a while. But when the data has outlived its life,
it's time to make the file go away. At the Unix shell level, we'd type an 
      <i>rm</i><a name="IXT-13-336470"></a> command to remove a file or files: 
      </p>
  
      <pre><font color="#cc0000">$ <b>rm slate bedrock lava</b></font></pre>
  
      <p class="docText">In Perl, we use the <tt><font color="#cc0000">unlink</font></tt><a
 name="IXT-13-336471"></a> operator: </p>
  
      <pre><font color="#cc0000">unlink "slate", "bedrock", "lava";</font></pre>
  
      <p class="docText">This sends the three named files away to bit heaven,
never to be seen again. </p>
  
      <p class="docText">Now, since <tt><font color="#cc0000">unlink</font></tt>
takes a list, and the <tt><font color="#cc0000">glob</font></tt><a
 name="IXT-13-336472"></a> function (described in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-12#lperl3-CHP-12">Chapter 12</a>)
returns a list, we can combine the two to delete many files at once: </p>
  
      <pre><font color="#cc0000">unlink glob "*.o";</font></pre>
  
      <p class="docText">This is similar to <tt><font color="#cc0000">rm
*.o</font></tt> at the shell, except that we didn't have to fire off a separate 
      <i>rm</i> process. So we can make those important files go away that
much faster! </p>
  
      <p class="docText">The return value from <tt><font color="#cc0000">unlink</font></tt>
tells us how many files have been successfully deleted. So, back to the first
example, we can check its success: </p>
  
      <pre><font color="#cc0000">my $successful = unlink "slate", "bedrock", "lava";<br>print "I deleted $successful file(s) just now\n";</font></pre>
  
      <p class="docText">Sure, if this number is <tt><font
 color="#cc0000">3</font></tt>, we know it removed all of the files, and
if it's <tt><font color="#cc0000">0</font></tt>, then we removed none of
them. But what if it's <tt><font color="#cc0000">1</font></tt> or <tt><font
 color="#cc0000">2</font></tt>? Well, there's no clue which ones were removed.
If you need to know, do them one at a time in a loop: </p>
  
      <pre><font color="#cc0000">foreach my $file (qw(slate bedrock lava)) {<br>  unlink $file or warn "failed on $file: $!\n";<br>}</font></pre>
  
      <p class="docText">Here, each file being deleted one at a time means
the return value will be <tt><font color="#cc0000">0</font></tt> (failed)
or <tt><font color="#cc0000">1</font></tt> (succeeded), which happens to
look like a nice Boolean value, controlling the execution of <tt><font
 color="#cc0000">warn</font></tt>. Using <tt><font color="#cc0000">or warn</font></tt>
is similar to <tt><font color="#cc0000">or die</font></tt>, except that it's
not fatal, of course (as we said back in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-11#lperl3-CHP-11">Chapter 11</a>).
In this case, we put the newline on the end of the message to warn, because
it's not a bug in <span class="docEmphasis">our</span> program that causes
the message. </p>
  
      <p class="docText">When a particular <tt><font color="#cc0000">unlink</font></tt>
fails, the <tt><font color="#cc0000">$!</font></tt> variable is set to something
related to the operating system error, which we've included in the message. 
This makes sense to use only when doing one filename at a time, because the
next operating system failed request resets the variable. You can't remove
a directory with <tt><font color="#cc0000">unlink</font></tt> (just like
you can't remove a directory with the simple <i>rm</i> invocation either).
Look for the <tt><font color="#cc0000">rmdir</font></tt> function coming
up shortly for that. </p>
  
      <p class="docText">Now, here's a little-known Unix fact. It turns out
that you can have a file that you can't read, you can't write, you can't
execute, maybe you don't even own the file&#8212;that is, it's somebody else's
file altogether&#8212;but you can still delete the file. That's because the <a
 name="IXT-13-336473"></a>permission to unlink a file doesn't depend upon
the permission bits on the file itself; it's the permission bits on the directory
that contains the file that matter. </p>
  
      <p class="docText">We mention this because it's normal for a beginning
Perl programmer, in the course of trying out <tt><font color="#cc0000">unlink</font></tt>, 
to make a file, to <i>chmod</i> it to <tt><font color="#cc0000">0</font></tt>
(so that it's not readable or writable), and then to see whether this makes
      <tt><font color="#cc0000">unlink</font></tt> fail. But instead it vanishes
without so much as a whimper.<sup class="docFootnote"><a class="docLink"
 href="#">[1]</a></sup> If you really want to see a failed <tt><font
 color="#cc0000">unlink</font></tt>, though, just try to remove <i>/etc/passwd</i>
or a similar system file. Since that's a file controlled by the system administrator,
you won't be able to remove it.<sup class="docFootnote"><a
 class="docLink" href="#">[2]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[1]</a></sup> Some of these
folks know that <i>rm </i>would generally ask before deleting such a file.
But <i>rm </i>is a command, and <tt><font color="#cc0000">unlink</font></tt>
is a system call. System calls never ask permission, and they never say they're
sorry.</p>
      </blockquote>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[2]</a></sup> Of course, if 
you're silly enough to try this kind of thing when you are logged in as the
system administrator, you deserve what you get. </p>
      </blockquote>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13-SECT-2"></a> 
      <h3 class="docSection1Title">13.2 Renaming Files</h3>
  
      <p class="docText">Giving an existing <a name="IXT-13-336474"></a>file 
a new name is simple with the <tt><font color="#cc0000">rename</font></tt><a
 name="IXT-13-336475"></a> function: </p>
  
      <pre><font color="#cc0000">rename "old", "new";</font></pre>
  
      <p class="docText">This is similar to the Unix <i>mv</i><a
 name="IXT-13-336476"></a> command, taking a file named <i>old</i> and giving
it the name <i>new</i> in the same directory. You can even move things around: 
      </p>
  
      <pre><font color="#cc0000">rename "over_there/some/place/some_file", "some_file";</font></pre>
  
      <p class="docText">This moves a file called <tt><font
 color="#cc0000">some_file</font></tt> from another directory into the current
directory, provided the user running the program has the appropriate permissions.<sup
 class="docFootnote"><a class="docLink" href="#">[3]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[3]</a></sup> And the files
must reside on the same filesystem. We'll see why this rule exists a little
later in this chapter.</p>
      </blockquote>
  
      <p class="docText">Like most functions that request something of the
operating system, <tt><font color="#cc0000">rename</font></tt> returns false
if it fails, and sets <tt><font color="#cc0000">$!</font></tt> with the operating
system error, so you can (and often should) use <tt><font
 color="#cc0000">or die</font></tt> (or <tt><font color="#cc0000">or warn</font></tt>)
to report this to the user. </p>
  
      <p class="docText">One frequent<sup class="docFootnote"><a
 class="docLink" href="#">[4]</a></sup> question in the Unix shell-usage
newsgroups is how to rename everything that ends with "<tt><font
 color="#cc0000">.old</font></tt><a name="IXT-13-336477"></a> <a
 name="IXT-13-336478"></a>" to the same name with "<tt><font
 color="#cc0000">.new</font></tt>". Here's how to do it in Perl nicely: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[4]</a></sup> This isn't just
any old frequent question; the question of renaming a batch of files at once
is the <span class="docEmphasis">most</span>frequent question asked in these
newsgroups. And that's why it's the <span class="docEmphasis">first</span> 
question answered in the FAQs for those newsgroups. And yet, it stays in
first place. Hmmm.</p>
      </blockquote>
  
      <pre><font color="#cc0000">foreach my $file (glob "*.old") {<br>  my $newfile = $file;<br>  $newfile =~ s/\.old$/.new/;<br>  if (-e $newfile) {<br>    warn "can't rename $file to $newfile: $newfile exists\n";<br>  } elsif (rename $file, $newfile) {<br>    ## success, do nothing<br>  } else {<br>    warn "rename $file to $newfile failed: $!\n";<br>  }<br>}</font></pre>
  
      <p class="docText">The check for the existence of <tt><font
 color="#cc0000">$newfile</font></tt> is needed because <tt><font
 color="#cc0000">rename</font></tt> will happily rename a file right over
the top of an existing file, presuming the user has permission to remove
the destination filename. We put the check in so that it's less likely that
we'll lose information this way. Of course, if you <span
 class="docEmphasis">wanted</span> to replace existing files like <i>wilma.new</i>,
you wouldn't bother testing with <tt><font color="#cc0000">-e</font></tt>
first. </p>
  
      <p class="docText">Those first two lines inside the loop can be combined
(and often are) to simply be: </p>
  
      <pre><font color="#cc0000">(my $newfile = $file) =~ s/\.old$/.new/;</font></pre>
  
      <p class="docText">This works to declare <tt><font color="#cc0000">$newfile</font></tt>,
copy its initial value from <tt><font color="#cc0000">$file</font></tt>,
then select <tt><font color="#cc0000">$newfile</font></tt> to be modified
by the substitution. You can read this as "transform <tt><font
 color="#cc0000">$file</font></tt> to <tt><font color="#cc0000">$newfile</font></tt>
using this replacement on the right." And yes, because of precedence, those
parentheses are required. </p>
  
      <p class="docText">Also, some programmers seeing this substitution
for the first time wonder why the backslash is needed on the left, but not
on the right. The two sides aren't symmetrical: the left part of a substitution
is a regular expression, and the right part is a double-quotish string. So
we use the pattern <tt><font color="#cc0000">/\.old$/</font></tt> to mean
"<tt><font color="#cc0000">.old</font></tt> anchored at the end of the string"
(anchored at the end, because we don't want to rename the <span
 class="docEmphasis">first</span> occurrance of <tt><font
 color="#cc0000">.old</font></tt> in a file called <i>betty.old.old</i>),
but on the right we can simply write <tt><font color="#cc0000">.new</font></tt>
to make the replacement. </p>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13-SECT-3"></a> 
      <h3 class="docSection1Title">13.3 Links and Files</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-886"></a>To understand more
about what's going on with files and directories, it helps to understand
the <a name="IXT-13-336479"></a>Unix model of files and directories, even
if your non-Unix system doesn't work in exactly this way. As usual, there's
more to the story than we're able to explain here, so check any good book
on Unix internal details if you need the full story. </p>
  
      <p class="docText">A <i>mounted volume</i><a name="IXT-13-336480"></a>
is a hard disk drive (or something else that works more-or-less like that,
such as a disk partition, a floppy disk, a CD-ROM, or a DVD-ROM). It may
contain any number of files and directories. Each file is stored in a numbered 
      <i>inode</i><a name="IXT-13-336481"></a>, which we can think of as
a particular piece of disk real estate. One file might be stored in inode
613, while another is in inode 7033. </p>
  
      <p class="docText">To locate a particular file, though, we'll have
to look it up in a directory. A <a name="IXT-13-336482"></a>directory is
a special kind of file, maintained by the system. Essentially, it is a table
of filenames and their inode numbers.<sup class="docFootnote"><a
 class="docLink" href="#">[5]</a></sup> Along with the other things in the 
directory, there are always two special directory entries. One is <tt><font
 color="#cc0000">.</font></tt> (called "<a name="IXT-13-336483"></a>dot"),
which is the name of that very directory; and the other is <tt><font
 color="#cc0000">..</font></tt><a name="IXT-13-336484"></a> <a
 name="IXT-13-336485"></a> ("dot-dot"), which is the directory one step higher
in the hierarchy (i.e., the directory's parent directory).<sup
 class="docFootnote"><a class="docLink" href="#">[6]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[5]</a></sup> On Unix systems
(others don't generally have inodes, hard links, and such), you can use the
        <i>ls </i>command's <span class="docEmphasis">-i</span> option to
see files' inode numbers. Try a command like <i>ls -ail</i>. When two or
more inode numbers are the same for multiple items on a given filesystem, 
there's really just one file involved, one piece of the disk.</p>
      </blockquote>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[6]</a></sup> The Unix system
        <span class="docEmphasis">root</span> directory has no parent. In
that directory, <tt><font color="#cc0000">..</font></tt> is the same directory
as <tt><font color="#cc0000">.</font></tt>, which is the system <span
 class="docEmphasis">root</span> directory itself. </p>
      </blockquote>
  
      <p class="docText"><a class="docLink" href="#lperl3-CHP-13-FIG-1">Figure
13-1</a> provides an illustration of two inodes. One is for a file called
      <i>chicken</i>, and the other is Barney's directory of poems, <i>/home/barney/poems</i>,
which contains that file. The file is stored in inode 613, while the directory
is stored in inode 919. (The directory's own name, <i>poems</i>, doesn't
appear in the illustration, because that's stored in another directory.)
The directory contains entries for three files (including <i>chicken</i>)
and two directories (one of which is the reference back to the directory
itself, in inode 919), along with each item's inode number. </p>
  
      <center> 
      <h5 class="docFigureTitle"><a name="lperl3-CHP-13-FIG-1"></a>Figure
13-1. The chicken before the egg</h5>
 <img border="0" width="342" height="134" src="lrnp_1301.gif"
 alt="lrnp_1301.gif">
      </center>
  
      <p class="docText">When it's time to make a new file in a given directory,
the system adds an entry with the file's name and the number of a new inode.
How can the system tell that a particular inode is available, though? Each
inode holds a number called its <i>link count</i><a name="IXT-13-336486"></a>.
The link count is always zero if the inode isn't listed in any directory,
so any inode with a link count of zero is available for new file storage.
When the inode is added to a directory, the link count is incremented; when
the listing is removed, the link count is decremented. For the file <i>chicken</i>
as illustrated above, the inode count of 1 is shown in the box above the
inode's data. </p>
  
      <p class="docText">But some inodes have more than one listing. For
example, we've already seen that each directory entry includes <tt><font
 color="#cc0000">.</font></tt>, which points back to that directory's own
inode. So the link count for a directory should always be at least two: its
listing in its parent directory and its listing in itself. In addition, if
it has subdirectories, each of those will add a link, since each will contain
      <tt><font color="#cc0000">..</font></tt>.<sup class="docFootnote"><a
 class="docLink" href="#">[7]</a></sup> In <a class="docLink"
 href="#lperl3-CHP-13-FIG-1">Figure 13-1</a>, the directory's inode count
of <tt><font color="#cc0000">2</font></tt> is shown in the box above its
data. A link count is the number of true names for the inode.<sup
 class="docFootnote"><a class="docLink" href="#">[8]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[7]</a></sup> This implies
that the link count of a directory is always equal to two plus the number
of directories it contains. On some systems that's true, in fact, but some
other systems work differently. </p>
      </blockquote>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[8]</a></sup> In the traditional
output of <i>ls -l</i>, the number of hard links to the item appears just
to the right of the permission flags (like "<tt><font color="#cc0000">-rwxr-xr-x</font></tt>").
Now you know why this number is more than one for directories and nearly
always <tt><font color="#cc0000">1</font></tt> for ordinary files.</p>
      </blockquote>
  
      <p class="docText">Could an ordinary file inode have more than one
listing in the directory? It certainly could. Suppose that, working in the
directory shown above, Barney uses the Perl's <tt><font color="#cc0000">link</font></tt><a
 name="IXT-13-336487"></a> function to create a new link: </p>
  
      <pre><font color="#cc0000">link "chicken", "egg"<br>  or warn "can't link chicken to egg: $!";</font></pre>
  
      <p class="docText">This is similar to typing "<tt><font
 color="#cc0000">ln chicken egg</font></tt>" at the Unix shell prompt. If 
      <tt><font color="#cc0000">link</font></tt> succeeds, it returns true.
If it fails, it returns false and sets <tt><font color="#cc0000">$!</font></tt>,
which Barney is checking in the error message. After this runs, the name <i>egg</i>
is another name for the file <i>chicken</i>, and vice versa; neither name
is "more real" than the other, and (as you may have guessed) it would take
some detective work to find out which came first. <a class="docLink"
 href="#lperl3-CHP-13-FIG-2">Figure 13-2</a> shows a picture of the new situation,
where there are two links to inode 613. </p>
  
      <center> 
      <h5 class="docFigureTitle"><a name="lperl3-CHP-13-FIG-2"></a>Figure
13-2. The egg is linked to the chicken</h5>
 <img border="0" width="342" height="134" src="lrnp_1302.gif"
 alt="lrnp_1302.gif">
      </center>
  
      <p class="docText">These two filenames are thus talking about the same
place on the disk. If the file <i>chicken</i> holds 200 bytes of data, <i>egg</i>
holds the same 200 bytes, for a total of 200 bytes (since it's really just
one file with two names). If Barney appends a new line of text to file <i>egg</i>,
that line will also appear at the end of <i>chicken.</i><sup
 class="docFootnote"><a class="docLink" href="#">[9]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[9]</a></sup> If you experiment
with making links and changing text files, be aware that most text editors 
don't edit the file "in place" but instead save a modified copy. If Barney
were to edit <i>egg </i>with a text editor, he'd most likely end up with
a new file called <i>egg </i>and the old file called <i>chicken</i>&#8212;two separate
files, rather than two links to the same file.</p>
      </blockquote>
  
      <p class="docText">Now, if Barney were to accidentally (or intentionally)
delete <i>chicken</i>, that data will not be lost&#8212;it's still available under
the name <i>egg</i>. And vice versa: if he were to delete <i>egg</i>, he'd
still have <i>chicken</i>. Of course, if he deletes both of them, the data
will be lost.<sup class="docFootnote"><a class="docLink" href="#">[10]</a></sup> 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[10]</a></sup> Although the
system won't necessarily overwrite this inode right away, there's no easy
way in general to get the data back once the link count has gone to zero.
Have you made a backup recently?</p>
      </blockquote>
  
      <p class="docText">There's another rule about the links in directory
listings: the inode numbers in a given directory listing all refer to inodes
on that same mounted volume.<sup class="docFootnote"><a class="docLink"
 href="#">[11]</a></sup> This rule ensures that if the physical medium (the
diskette, perhaps) is moved to another machine, all of the directories stick
together with their files. That's why you can use <tt><font
 color="#cc0000">rename</font></tt> to move a file from one directory to
another, but only if both directories are on the same filesystem (mounted
volume). If they were on different disks, the inode's data would have to
be relocated, which is too complex an operation for a simple system call. 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[11]</a></sup> The one exception
is the special <tt><font color="#cc0000">..</font></tt> entry in the volume's 
        <span class="docEmphasis">root</span> directory, which refers to
the directory in which that volume is mounted. </p>
      </blockquote>
  
      <p class="docText">And yet another restriction on links is that they
can't make new names for directories. That's because the directories are arranged
in a hierarchy. If you were able to change that, utility programs like <i>find</i>
and <i>pwd</i> could easily become lost trying to find their way around the 
filesystem. </p>
  
      <p class="docText">So, links can't be added to directories, and they
can't cross from one mounted volume to another. Fortunately, there's a way
to get around these restrictions on links, by using a new and different kind
of link: a <i>symbolic link</i><a name="IXT-13-336488"></a> <a
 name="IXT-13-336489"></a>.<sup class="docFootnote"><a class="docLink"
 href="#">[12]</a></sup> A symbolic link (also called a <i>soft link</i><a
 name="IXT-13-336490"></a> <a name="IXT-13-336491"></a> to distinguish it
from the true or <i>hard links</i><a name="IXT-13-336492"></a> <a
 name="IXT-13-336493"></a> that we've been talking about up to now) is a
special entry in a directory that tells the system to look elsewhere. Let's
say that Barney (working in the same directory of poems as before) creates
a symbolic link with Perl's <tt><font color="#cc0000">symlink</font></tt><a
 name="IXT-13-336494"></a> function, like this: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[12]</a></sup> Some veryold
Unix systems don't support symlinks, but those are pretty rare nowadays.</p>
      </blockquote>
  
      <pre><font color="#cc0000">symlink "dodgson", "carroll"<br>  or warn "can't symlink dodgson to carroll: $!";</font></pre>
  
      <p class="docText">This is similar to what would happen if Barney used
the command "<i>ln -s dodgson carroll</i>" from the shell. <a
 class="docLink" href="#lperl3-CHP-13-FIG-3">Figure 13-3</a> shows a picture
of the result, including the poem in inode 7033. </p>
  
      <center> 
      <h5 class="docFigureTitle"><a name="lperl3-CHP-13-FIG-3"></a>Figure
13-3. A symlink to inode 7033</h5>
 <img border="0" width="318" height="146" src="lrnp_1303.gif"
 alt="lrnp_1303.gif">
      </center>
  
      <p class="docText">Now if Barney chooses to read <i>/home/barney/poems/carroll</i>,
he gets the same data as if he had opened <i>/home/barney/poems/dodgson</i>,
because the system follows the symbolic link automatically. But that new
name isn't the "real" name of the file, because (as you can see in the diagram)
the link count on inode 7033 is still just one. That's because the symbolic
link simply tells the system, "If you got here looking for <i>carroll</i>,
now you want to go off to find something called <i>dodgson</i> instead." </p>
  
      <p class="docText">A symbolic link can freely cross mounted filesystems
or provide a new name for a directory, unlike a hard link. In fact, a symbolic
link could point to any filename, one in this directory or in another one&#8212;or
even to a file that doesn't exist! But that also means that a soft link can't
keep data from being lost as a hard link can, since the symlink doesn't contribute
to the link count. If Barney were to delete <i>dodgson</i>, the system would
no longer be able to follow the soft link.<sup class="docFootnote"><a
 class="docLink" href="#">[13]</a></sup> Even though there would still be
an entry called <i>carroll</i>, trying to read from it would give an error
like <tt><font color="#cc0000">file not found</font></tt>. The file test
      <tt><font color="#cc0000">-l 'carroll'</font></tt> would report true,
but <tt><font color="#cc0000">-e 'carroll'</font></tt> would be false: it's
a symlink, but it doesn't exist. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[13]</a></sup> Deleting <i>carroll
        </i>would merely remove the symlink, of course.</p>
      </blockquote>
  
      <p class="docText">Since a soft link could point to a file that doesn't
yet exist, it could be used when creating a file as well. Barney has most
of his files in his home directory, <i>/home/barney</i>, but he also needs
frequent access to a directory with a long name that is difficult to type: 
      <i>/usr/local/opt/system/httpd/root-dev/users/staging/barney/cgi-bin</i>. 
So he sets up a symlink named <i>/home/barney/my_stuff</i>, which points
to that long name, and now it's easy for him to get to it. If he creates
a file (from his home directory) called <i>my_stuff/bowling</i>, that file's
real name is <i>/usr/local/opt/system/httpd/root-dev/users/staging/barney/cgi-bin/bowling</i>. 
Next week, when the system administrator moves these files of Barney's to 
      <i>/usr/local/opt/internal/httpd/www-dev/users/staging/barney/cgi-bin</i>, 
Barney just repoints the one symlink, and now he and all of his programs
can still find his files with ease. </p>
  
      <p class="docText">It's normal for either <i>/usr/bin/perl</i> or <i>/usr/local/bin/perl</i>
(or both) to be symbolic links to the true Perl binary on your system. This
makes it easy to switch to a new version of Perl. Say you're the system administrator,
and you've built the new Perl. Of course, your older version is still running,
and you don't want to disrupt anything. When you're ready for the switch,
you simply move a symlink or two, and now every program that begins with <tt><font
 color="#cc0000">#!/usr/bin/perl</font></tt> will automatically use the new 
version. In the unlikely case that there's some problem, it's a simple thing
to replace the old symlinks and have the older Perl running the show again.
(But, like any good admin, you notified your users to test their code with
the new <i>/usr/bin/perl-7.2</i> well in advance of the switch, and you told
them that they can keep using the older one during the next month's grace
period by changing their programs' first lines to <tt><font
 color="#cc0000">#!/usr/bin/perl-6.1</font></tt>, if they need to.) </p>
  
      <p class="docText">Perhaps suprisingly, both hard and soft links are
very useful. Many non-Unix operating systems have neither, and the lack is
sorely felt. On some non-Unix systems, symbolic links may be implemented
as a "shortcut" or an "alias"&#8212;check the <span class="docEmphasis">perlport</span>
manpage for the latest details. </p>
  
      <p class="docText">To find out where a symbolic link is pointing, use
the <tt><font color="#cc0000">readlink</font></tt> function. This will tell
you where the symlink leads, or it will return <tt><font color="#cc0000">undef</font></tt>
if its argument wasn't a symlink: </p>
  
      <pre><font color="#cc0000">my $where = readlink "carroll";             # Gives "dodgson"<br><br>my $perl = readlink "/usr/local/bin/perl";  # Maybe tells where perl is</font></pre>
  
      <p class="docText">You can remove either kind of link with <tt><font
 color="#cc0000">unlink</font></tt>&#8212;and now you see where that operation gets
its name. <tt><font color="#cc0000">unlink</font></tt> simply removes the
directory entry associated with the given filename, decrementing the link
count and thus possibly freeing the inode.<a name="IXTR3-82"></a> </p>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
 
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13-SECT-4"></a> 
      <h3 class="docSection1Title">13.4 Making and Removing Directories</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-904"></a> <a
 name="lperl3-IDXTERM-905"></a>Making <i></i><a
 name="lperl3-IDXTERM-906"></a>a directory inside an existing directory is
easy. Just invoke the <tt><font color="#cc0000">mkdir</font></tt> function: 
      </p>
  
      <pre><font color="#cc0000">mkdir "fred", 0755 or warn "Cannot make fred directory: $!";</font></pre>
  
      <p class="docText">Again, true means success, and <tt><font
 color="#cc0000">$!</font></tt> is set on failure. </p>
  
      <p class="docText">But what's that second parameter, <tt><font
 color="#cc0000">0755</font></tt>? That's the initial permission setting<sup
 class="docFootnote"><a class="docLink" href="#">[14]</a></sup> on the newly
created directory (you can always change it later). The value here is specified
as an octal value because the value will be interpreted as a Unix permission
value, which has a meaning based on groups of three bits each, and octal
values represent that nicely. Yes, even on Windows or MacPerl, you still need
to know a little about Unix permissions values to use the <tt><font
 color="#cc0000">mkdir</font></tt> function. Mode <tt><font
 color="#cc0000">0755</font></tt> is a good one to use, because it gives
you full permission, but lets everyone else have read access but no permission
to change anything. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[14]</a></sup> The permission
value is modified by the umask value in the usual way. See <tt><font
 color="#cc0000">umask(2)</font></tt> for further information.</p>
      </blockquote>
  
      <p class="docText">The <tt><font color="#cc0000">mkdir</font></tt>
function doesn't require you to specify this value in octal&#8212;it's just looking
for a numeric value (either a literal or a calculation). But unless you can 
quickly can figure that <tt><font color="#cc0000">0755</font></tt> octal
is <tt><font color="#cc0000">493</font></tt> decimal in your head, it's probably 
easier to let Perl calculate that. And if you accidentally leave off the
leading zero, you get <tt><font color="#cc0000">755</font></tt> decimal,
which is <tt><font color="#cc0000">1363</font></tt> octal, a strange permission
combination indeed. </p>
  
      <p class="docText">As we saw earlier (in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-2#lperl3-CHP-2">Chapter 2</a>), a
string value being used as a number is never interpreted as octal, even if
it starts with a leading 0. So this doesn't work: </p>
  
      <pre><font color="#cc0000">my $name = "fred";<br>my $permissions = "0755";  # danger... this isn't working<br>mkdir $name, $permissions;</font></pre>
  
      <p class="docText">Oops, we just created a directory with that bizarre 
      <tt><font color="#cc0000">01363</font></tt> permissions, because <tt><font
 color="#cc0000">0755</font></tt> was treated as decimal. To fix that, use
the <tt><font color="#cc0000">oct</font></tt> function, which forces octal
interpretation of a string whether or not there's a leading zero: </p>
  
      <pre><font color="#cc0000">mkdir $name, oct($permissions);</font></pre>
  
      <p class="docText">Of course, if you are specifying the permission
value directly within the program, just use a number instead of a string.
The need for the extra <tt><font color="#cc0000">oct</font></tt> function
shows up most often when the value comes from user input. For example, suppose
we take the arguments from the command line: </p>
  
      <pre><font color="#cc0000">my ($name, $perm) = @ARGV;  # first two args are name, permissions<br>mkdir $name, oct($perm) or die "cannot create $name: $!";</font></pre>
  
      <p class="docText">The value here for <tt><font color="#cc0000">$perm</font></tt>
is interpreted as a string initially, and thus the <tt><font
 color="#cc0000">oct</font></tt> function interprets the common octal representation
properly. </p>
  
      <p class="docText">To remove empty directories, use the <tt><font
 color="#cc0000">rmdir</font></tt> function in a manner similar to the <tt><font
 color="#cc0000">unlink</font></tt> function: </p>
  
      <pre><font color="#cc0000">rmdir glob "fred/*";  # remove all empty directories below fred/<br><br>foreach my $dir (qw(fred barney betty)) {<br>  rmdir $dir or warn "cannot rmdir $dir: $!\n";<br>}</font></pre>
  
      <p class="docText">As with <tt><font color="#cc0000">unlink</font></tt>,
      <tt><font color="#cc0000">rmdir</font></tt> returns the number of directories
removed, and if invoked with a single name, sets <tt><font
 color="#cc0000">$!</font></tt> in a reasonable manner on a failure. </p>
  
      <p class="docText">The <tt><font color="#cc0000">rmdir</font></tt><a
 name="IXT-13-336495"></a> operator fails for non-empty directories. As a
first pass, you can attempt to delete the contents of the directory with
      <tt><font color="#cc0000">unlink</font></tt>, then try to remove what
should now be an empty directory. For example, suppose we need a place to
write many temporary files during the execution of a program: </p>
  
      <pre><font color="#cc0000">my $temp_dir = "/tmp/scratch_$$";       # based on process ID; see the text<br>mkdir $temp_dir, 0700 or die "cannot create $temp_dir: $!";<br>...<br># use $temp_dir as location of all temporary files<br>...<br>unlink glob "$temp_dir/* $temp_dir/.*"; # delete contents of $temp_dir<br>rmdir $temp_dir;                        # delete now-empty directory</font></pre>
  
      <p class="docText">The initial temporary directory name includes the
current process ID, which is unique for every running process and is accessed
with the <tt><font color="#cc0000">$$</font></tt> variable (similar to the
shell). We do this to avoid colliding with any other processes, as long as
they also include their process ID as part of their pathname as well. (In
fact, it's common to use the program's name as well as the process ID, so
if the program is called <tt><font color="#cc0000">quarry</font></tt>, the
directory would probably be something like <tt><font color="#cc0000">/tmp/quarry_$$</font></tt>.) 
      </p>
  
      <p class="docText">At the end of the program, that last <tt><font
 color="#cc0000">unlink</font></tt> should remove all the files in this temporary
directory, and then the <tt><font color="#cc0000">rmdir</font></tt> function
can delete the then-empty directory. However, if we've created subdirectories
under that directory, the <tt><font color="#cc0000">unlink</font></tt> operator
fails on those, and the <tt><font color="#cc0000">rmdir</font></tt> also
fails. For a more robust solution, check out the <tt><font
 color="#cc0000">rmtree</font></tt><a name="IXT-13-336496"></a> function
provided by the <tt><font color="#cc0000">File::Path</font></tt> module of
the standard<i></i><a name="IXTR3-83"></a> distribution.<a
 name="IXTR3-84"></a> <a name="IXTR3-85"></a> </p>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13-SECT-5"></a> 
      <h3 class="docSection1Title">13.5 Modifying Permissions</h3>
  
      <p class="docText">The Unix <i>chmod</i><a name="IXT-13-336497"></a>
command changes the <a name="IXT-13-336498"></a>permissions on a file or
directory. Similarly, Perl has the <tt><font color="#cc0000">chmod</font></tt><a
 name="IXT-13-336499"></a> function to perform this task: </p>
  
      <pre><font color="#cc0000">chmod 0755, "fred", "barney";</font></pre>
  
      <p class="docText">As with many of the operating system interface functions, 
      <tt><font color="#cc0000">chmod</font></tt> returns the number of items
successfully altered, and when used with a single argument, sets <tt><font
 color="#cc0000">$!</font></tt> in a sensible way for error messages when
it fails. The first parameter is the Unix permission value (even for non-Unix
versions of Perl). For the same reasons we presented earlier in describing
      <tt><font color="#cc0000">mkdir</font></tt>, this value is usually specified
in octal. </p>
  
      <p class="docText">Symbolic permissions (like <i>+x</i> or <i>go=u-w</i>)
accepted by the Unix <i>chmod</i> command are not valid for the <tt><font
 color="#cc0000">chmod</font></tt> function.<sup class="docFootnote"><a
 class="docLink" href="#">[15]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[15]</a></sup> Unless you've
installed and invoke the <tt><font color="#cc0000">File::chmod</font></tt> 
module from CPAN, which can apparently upgrade the <tt><font
 color="#cc0000">chmod</font></tt> operator to understand symbolic mode values.</p>
      </blockquote>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13-SECT-6"></a> 
      <h3 class="docSection1Title">13.6 Changing Ownership</h3>
  
      <p class="docText">If the operating system permits it, you may change
the ownership and group membership of a list of <a name="IXT-13-336500"></a>files
with the <tt><font color="#cc0000">chown</font></tt><a
 name="IXT-13-336501"></a> function. The user and group are both changed
at once, and both have to be the <a name="IXT-13-336502"></a>numeric user-ID
and <a name="IXT-13-336503"></a>group-ID values. For example: </p>
  
      <pre><font color="#cc0000">my $user = 1004;<br>my $group = 100;<br>chown $user, $group, glob "*.o";</font></pre>
  
      <p class="docText">What if you have a username like <tt><font
 color="#cc0000">merlyn</font></tt> instead of the number? Simple. Just call
the <tt><font color="#cc0000">getpwnam</font></tt><a
 name="IXT-13-336504"></a> function to translate the name into a number,
and the corresponding <tt><font color="#cc0000">getgrnam<sup
 class="docFootnote"><a class="docLink" href="#">[16]</a></sup></font></tt><a
 name="IXT-13-336505"></a> to translate the group name into its number: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[16]</a></sup> These two are
among the ugliest function names known to mankind. But don't blame Larry
for them; he's just giving them the same names that the folks at Berkeley
did. </p>
      </blockquote>
  
      <pre><font color="#cc0000">defined(my $user = getpwnam "merlyn") or die "bad user";<br>defined(my $group = getgrnam "users") or die "bad group";<br>chown $user, $group, glob "/home/merlyn/*";</font></pre>
  
      <p class="docText">The <tt><font color="#cc0000">defined</font></tt><a
 name="IXT-13-336506"></a> function verifies that the return value is not
      <tt><font color="#cc0000">undef</font></tt>, which will be returned
if the requested user or group is not valid. </p>
  
      <p class="docText">The <tt><font color="#cc0000">chown</font></tt>
function returns the number of files affected, and it sets <tt><font
 color="#cc0000">$!</font></tt> on error. </p>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13-SECT-7"></a> 
      <h3 class="docSection1Title">13.7 Changing Timestamps</h3>
  
      <p class="docText">In those rare cases when you want to lie to other
programs about when a file was most recently modified or accessed, you can
use the <tt><font color="#cc0000">utime</font></tt><a
 name="IXT-13-336507"></a> function to fudge the books a bit. The first two
arguments give the new access time and modification <a
 name="IXT-13-336508"></a>time, while the remaining arguments are the list
of filenames to alter to those timestamps. The times are specified in internal
timestamp format (the same type of values returned from the <tt><font
 color="#cc0000">stat</font></tt> function that we mentioned in <a
 class="docLink" href="?xmlid=0-596-00132-0/lperl3-CHP-12#lperl3-CHP-12">Chapter
12</a>).  </p>
  
      <p class="docText">One convenient value to use for the timestamps is
"right now", returned in the proper format by the <tt><font
 color="#cc0000">time</font></tt> function. So to update all the files in
the current directory to look like they were modified a day ago, but accessed
just now, we could simply do this: </p>
  
      <pre><font color="#cc0000">my $now = time;<br>my $ago = $now - 24 * 60 * 60;  # seconds per day<br>utime $now, $ago, glob "*";     # set access to now, mod to a day ago</font></pre>
  
      <p class="docText">Of course, nothing stops you from creating a file
that is arbitrarily stamped far in the future or past (within the limits
of the Unix timestamp values of 1970 to 2038, or whatever your non-Unix system 
uses, until we get 64-bit timestamps). Maybe you could use this to create
a directory where you keep your notes for that time-travel novel you're writing. 
      </p>
  
      <p class="docText">The third timestamp (the <a
 name="IXT-13-336509"></a> <a name="IXT-13-336510"></a> <a
 name="IXT-13-336511"></a>ctime value) is always set to "now" whenever anything
alters a file, so there's no way to set it (it would have to be reset to "now"
after you set it) with the <tt><font color="#cc0000">utime</font></tt> function.
That's because it's primary purpose is for incremental backups: if the file's
ctime is newer than the date on the backup tape, it's time to back it up
again. </p>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13-SECT-8"></a> 
      <h3 class="docSection1Title">13.8 Using Simple Modules</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-927"></a>Suppose <i></i><a
 name="lperl3-IDXTERM-928"></a>that you've got a long filename like <i>/usr/local/bin/perl</i>
in your program, and you need to find out the <i>basename.</i> That's easy
enough, since the basename is everything after the last slash (it's just
"<i>perl</i>" in this case): </p>
  
      <pre><font color="#cc0000">my $name = "/usr/local/bin/perl";<br>(my $basename = $name) =~ s#.*/##;  # Oops!</font></pre>
  
      <p class="docText">As we saw earlier, first Perl will do the assignment
inside the parentheses, then it will do the substitution. The substitution
is supposed to replace any string ending with a slash (that is, the directory
name portion) with an empty string, leaving just the basename. </p>
  
      <p class="docText">And if you try this, it seems to work. Well, it <span
 class="docEmphasis">seems</span> to, but actually, there are three problems. 
      </p>
  
      <p class="docText">First, a Unix file or directory name could contain
a newline character. (It's not something that's likely to happen by accident,
but it's permitted.) So, since the regular expression dot ("<tt><font
 color="#cc0000">.</font></tt>") can't match a newline, a filename like the
string <tt><font color="#cc0000">"/home/fred/flintstone\n/brontosaurus"</font></tt>
won't work right&#8212;that code would think the basename is <tt><font
 color="#cc0000">"flintstone\n/brontosaurus"</font></tt>. You could fix that 
with the <tt><font color="#cc0000">/s</font></tt> option to the pattern (if
you remembered about this subtle and infrequent case), making the substitution
look like this: <tt><font color="#cc0000">s#.*/##s</font></tt> </p>
  
      <p class="docText">The second problem is that this is Unix-specific.
It assumes that the forward slash will always be the directory separator,
as it is on Unix, and not the backslash or colon that some systems use. </p>
  
      <p class="docText">And the third (and biggest) problem with this is
that we're trying to solve a problem that someone else has already solved.
Perl comes with a number of <i>modules</i>, which are smart extensions to
Perl that add to its functionality. And if those aren't enough, there are
many other useful modules available on <a name="IXT-13-336512"></a>CPAN,
with new ones being added every week. You (or, better yet, your system administrator)
can install them if you need their functionality. </p>
  
      <p class="docText">In the rest of this section, we'll show you how
to use some of the features of a couple of simple modules that come with
Perl. (There's more that these modules can do; this is just an overview to
illustrate the general principles of how to use a simple module.) </p>
  
      <p class="docText">Alas, we can't show you everything you'd need to
know about using modules in general, since you'd have to understand advanced
topics like references and objects in order to use some modules.<sup
 class="docFootnote"><a class="docLink" href="#">[17]</a></sup> But this
section should prepare you for using many simple modules. Further information
on some interesting and useful modules is included in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-APP-B#lperl3-APP-B">Appendix B</a>. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[17]</a></sup> As we'll see
in the next few pages, though, you may be able to use a module that uses
objects and references without having to understand those advanced topics.</p>
      </blockquote>
  <a name="lperl3-CHP-13-SECT-8.1"></a> 
      <h4 class="docSection2Title">13.8.1 The File::Basename Module</h4>
  
      <p class="docText"><a name="lperl3-IDXTERM-930"></a> <a
 name="lperl3-IDXTERM-931"></a>In the previous example, we found the basename
of a filename in a way that's not portable. We showed that something that
seemed straightforward was susceptible to subtle mistaken assumptions (here,
the assumption was that newlines would never appear in file or directory
names). And we were re-inventing the wheel, solving a problem that others
have solved (and debugged) many times before us. </p>
  
      <p class="docText">Here's a better way to extract the basename of a
filename. Perl comes with a module called <tt><font color="#cc0000">File::Basename</font></tt>.
With the command <i>perldoc File::Basename</i>, or with your system's documentation
system, you can read about what it does. That's the first step when using
a new module. (It's often the third and fifth step, as well.) </p>
  
      <p class="docText">Soon you're ready to use it, so you declare it with
a <tt><font color="#cc0000">use</font></tt> directive near the top of your 
program:<sup class="docFootnote"><a class="docLink" href="#">[18]</a></sup> 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[18]</a></sup> It's traditional
to declare modules near the top of the file, since that makes it easy for
the maintenance programmer to see which modules you'll be using. That greatly
simplifies matters when it's time to install your program on a new machine,
for example.</p>
      </blockquote>
  
      <pre><font color="#cc0000">use File::Basename;</font></pre>
  
      <p class="docText">During compilation, Perl sees that line and loads
up the module. Now, it's as if Perl has some new functions that you may use
in the remainder of your program.<sup class="docFootnote"><a
 class="docLink" href="#">[19]</a></sup> The one we wanted in the earlier
example is the <tt><font color="#cc0000">basename</font></tt> function itself: 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[19]</a></sup> You guessed
it: there's more to the story, having to do with packages and fully qualified
names. When your programs are growing beyond a few hundred lines in the main
program (not counting code in modules), which is quite large in Perl, you
should probably read up about these advanced features. Start with the <span
 class="docEmphasis">perlmod</span> manpage.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my $name = "/usr/local/bin/perl";<br>my $basename = basename $name;  # gives 'perl'</font></pre>
  
      <p class="docText">Well, that worked for Unix. What if our program
were running on MacPerl or Windows or VMS, to name a few? There's no problem&#8212;this
module can tell which kind of machine you're using, and it uses that machine's
filename rules by default. (Of course, you'd have that machine's kind of
filename string in <tt><font color="#cc0000">$name</font></tt>, in that case.) 
      </p>
  
      <p class="docText">There are some related functions also provided by
this module. One is the <tt><font color="#cc0000">dirname</font></tt><a
 name="IXT-13-336513"></a> function, which pulls the directory name from
a full filename. The module also lets you separate a filename from its extension,
or change the default set of filename rules.<sup class="docFootnote"><a
 class="docLink" href="#">[20]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[20]</a></sup> You might need
to change the filename rules if you were trying to work with a Unix machine's 
filenames from a Windows machine&#8212;perhaps while sending commands over an FTP
connection, for example.</p>
      </blockquote>
   <a name="lperl3-CHP-13-SECT-8.2"></a> 
      <h4 class="docSection2Title">13.8.2 Using Only Some Functions from
a Module</h4>
  
      <p class="docText">Suppose you discovered that when you went to add
the <tt><font color="#cc0000">File::Basename</font></tt> module to your existing
program, you already have a subroutine called <tt><font color="#cc0000">&amp;dirname</font></tt>&#8212;that
is, you already have a subroutine with the same name as one of the <a
 name="IXT-13-336514"></a>module's functions.<sup class="docFootnote"><a
 class="docLink" href="#">[21]</a></sup> Now there's trouble, because the
new <tt><font color="#cc0000">dirname</font></tt> is <span
 class="docEmphasis">also</span> implemented as a Perl subroutine (inside 
the module). What do you do? </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[21]</a></sup> Well, it's
not likely that you would already have a <tt><font color="#cc0000">&amp;dirname</font></tt>
subroutine that you use for another purpose, but this is just an example.
Some modules offer hundreds (really!) of new functions, making a name collision 
that much more frequent.</p>
      </blockquote>
  
      <p class="docText">Simply give <tt><font color="#cc0000">File::Basename</font></tt>,
in your <tt><font color="#cc0000">use</font></tt> declaration, an <i>import 
list</i><a name="IXT-13-336515"></a> showing exactly which function names
it should give you, and it'll supply those and no others. Here, we'll get
nothing but <tt><font color="#cc0000">basename</font></tt>: </p>
  
      <pre><font color="#cc0000">use File::Basename qw/ basename /;</font></pre>
  
      <p class="docText">And here, we'll ask for no new functions at all:</p>
  
      <pre><font color="#cc0000">use File::Basename qw/ /;</font></pre>
  
      <p class="docText">Why would you want to do that? Well, this directive
tells Perl to load up <tt><font color="#cc0000">File::Basename</font></tt>,
just as before, but not to <i>import</i> any function names. Importing lets
us use the short, simple function names like <tt><font color="#cc0000">basename</font></tt> 
and <tt><font color="#cc0000">dirname</font></tt>. But even if we don't import 
those names, we can still use the functions. When they're not imported, though,
we have to call them by their full names: </p>
  
      <pre><font color="#cc0000">use File::Basename qw/ /;                     # import no function names<br><br>my $betty = &amp;dirname($wilma);                 # uses our own subroutine &amp;dirname (not shown)<br><br>my $name = "/usr/local/bin/perl";<br>my $dirname = File::Basename::dirname $name;  # dirname from the module</font></pre>
  
      <p class="docText">As you see, the full name of the <tt><font
 color="#cc0000">dirname</font></tt> function from the module is <tt><font
 color="#cc0000">File::Basename::dirname</font></tt>. We can always use the
function's full name (once we've loaded the module) whether we've imported
the short name <tt><font color="#cc0000">dirname</font></tt> or not. </p>
  
      <p class="docText">Most of the time, you'll want to use a module's
default import list. But you can always override that with a list of your 
own, if you want to leave out some of the default items. Another reason to
supply your own list would be if you wanted to import some function not on
the default list, since most modules include some (infrequently needed) functions
that are not on the default import list. </p>
  
      <p class="docText">As you'd guess, some modules will, by default, import
more symbols than others. Each module's documentation should make it clear
which symbols it imports, if any, but you are always free to override the
default import list by specifying one of your own, just as we did with <tt><font
 color="#cc0000">File::Basename</font></tt>. Supplying an empty list imports
no<a name="IXTR3-86"></a> symbols.<a name="IXTR3-87"></a> <a
 name="IXTR3-88"></a> </p>
   <a name="lperl3-CHP-13-SECT-8.3"></a> 
      <h4 class="docSection2Title">13.8.3 The File::Spec Module</h4>
  
      <p class="docText"><a name="lperl3-IDXTERM-938"></a>Now you can find
out a file's basename. That's useful, but you'll often want to put that together
with a directory name to get a full filename. For example, here we want to
take a filename like <i>/home/rootbeer/ice-2.1.txt</i> and add a prefix to 
the basename: </p>
  
      <pre><font color="#cc0000">use File::Basename;<br><br>print "Please enter a filename: ";<br>chomp(my $old_name = &lt;STDIN&gt;);<br><br>my $dirname = dirname $old_name;<br>my $basename = basename $old_name;<br><br>$basename =~ s/^/not/;  # Add a prefix to the basename<br>my $new_name = "$dirname/$basename";<br><br>rename($old_name, $new_name)<br>  or warn "Can't rename '$old_name' to '$new_name': $!";</font></pre>
  
      <p class="docText">Do you see the problem here? Once again, we're making
the assumption that filenames will follow the Unix conventions and use a forward
slash between the directory name and the basename. Fortunately, Perl comes
with a module to help with this problem, too. </p>
  
      <p class="docText">The <tt><font color="#cc0000">File::Spec</font></tt>
module is used for manipulating <i>file specifications</i><a
 name="IXT-13-336516"></a>, which are the names of files, directories, and
the other things that are stored on filesystems. Like <tt><font
 color="#cc0000">File::Basename</font></tt>, it understands what kind of
system it's running on, and it chooses the right set of rules every time.
But unlike <tt><font color="#cc0000">File::Basename</font></tt>, <tt><font
 color="#cc0000">File::Spec</font></tt> is an object-oriented (often abbreviated
"OO") module. </p>
  
      <p class="docText">If you've never caught the fever of OO, don't let
that bother you. If you understand objects, that's great; you can use this
OO module. If you don't understand objects, that's okay, too. You just type
the symbols as we show you, and it works just as if you knew what you were
doing. </p>
  
      <p class="docText">In this case, we learn from reading the documentation
for <tt><font color="#cc0000">File::Spec</font></tt> that we want to use
a <i>method</i><a name="IXT-13-336517"></a> called <tt><font
 color="#cc0000">catfile</font></tt>. What's a method? It's just a different
kind of function, as far as we're concerned here. The difference is that
you'll always call the methods from <tt><font color="#cc0000">File::Spec</font></tt>
with their full names, like this: </p>
  
      <pre><font color="#cc0000">use File::Spec;<br><br>.<br>.  # Get the values for $dirname and $basename as above<br>.<br><br>my $new_name = File::Spec-&gt;catfile($dirname, $basename);<br><br>rename($old_name, $new_name)<br>  or warn "Can't rename '$old_name' to '$new_name': $!";</font></pre>
  
      <p class="docText">As you can see, the full name of a method is the
name of the module (called a <i>class</i><a name="IXT-13-336518"></a>, here),
a <a name="IXT-13-336519"></a> <a name="IXT-13-336520"></a>small arrow, and
the short name of the method. It is important to use the small arrow, rather
than the double-colon that we used with <tt><font color="#cc0000">File::Basename</font></tt>. 
      </p>
  
      <p class="docText">Since we're calling the method by its full name,
though, what symbols does the module import? None of them. That's normal
for OO modules. So you don't have to worry about having a subroutine with
the same name as one of the many methods of <tt><font color="#cc0000">File::Spec</font></tt>. 
      </p>
  
      <p class="docText">Should you bother using modules like these? It's
up to you, as always. If you're sure your program will never be run anywhere 
but on a Unix machine, say, and you're sure you completely understand the
rules for filenames on Unix,<sup class="docFootnote"><a class="docLink"
 href="#">[22]</a></sup> then you may prefer to hardcode your assumptions
into your programs. But these modules give you an easy way to make your programs
more robust in less time&#8212;and more <a name="IXT-13-336521"></a>portable at
no extra<a name="IXTR3-89"></a> charge.<a name="IXTR3-90"></a> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[22]</a></sup> If you didn't
know that filenames and directory names could contain newline characters,
as we mentioned earlier in this section, then you <span
 class="docEmphasis">don't</span> know all the rules, do you? </p>
      </blockquote>
    
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-13-SECT-9"></a> 
      <h3 class="docSection1Title">13.9 Exercises</h3>
  
      <p class="docText">The programs here are potentially dangerous! Be
careful to test them in a mostly empty directory to make it difficult to
accidentally delete something useful. </p>
  
      <p class="docText">See <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-APP-A-SECT-12#lperl3-APP-A-SECT-12">Section
A.12</a> for answers to the following exercises. </p>
  <span style="font-weight: bold;">
      <ol class="docList" type="1">
 <li><span style="font-weight: normal;">
          <p class="docList">[6] Write a program that works like <span
 class="docEmphasis">rm</span>, deleting any files named on the command line.
(You don't need to handle any of the options of <span
 class="docEmphasis">rm</span>.) </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[10] Write a program that works like <span
 class="docEmphasis">mv</span>, renaming the first command-line argument
to the second command-line argument. (You don't need to handle any of the
options of <span class="docEmphasis">mv</span> or additional arguments.)
Remember to allow for the destination to be a directory; if it is, use the
same original basename in the new directory. </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[7] If your operating system supports it, write
a program that works like <span class="docEmphasis">ln</span>, making a hard
link from the first command-line argument to the second. (You don't need
to handle options of <span class="docEmphasis">ln</span> or more arguments.)
If your system doesn't have hard links, just print out a message telling
what operation you would perform if it were available. Hint: This program 
has something in common with the previous one&#8212;recognizing that could save
you time in coding. </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[7] If your operating system supports it, fix
up the program from the previous exercise to allow an optional <span
 class="docEmphasis">-s</span> switch before the other arguments to indicate
that you want to make a soft link instead of a hard link. (Even if you don't
have hard links, see whether you can at least make soft links with this program.) 
          </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[7] If your operating system supports it, write
a program to find any symbolic links in the current directory and print out
their values (like <span class="docEmphasis">ls -l</span> would: <tt><font
 color="#cc0000">name -&gt; value</font></tt>).<a name="IXTR3-91"></a> </p>
          </span></li>
 
      </ol>
      </span>  
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
 
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-14"></a>  
      <h2 class="docChapterTitle">Chapter 14. Process Management</h2>
  
      <p class="docText"><a name="lperl3-IDXTERM-948"></a> <a
 name="lperl3-IDXTERM-949"></a> <a name="lperl3-IDXTERM-950"></a>One of the
best parts of being a programmer is launching someone else's code so that
you don't have to write it yourself. It's time to learn how to manage your
children<sup class="docFootnote"><a class="docLink" href="#">[1]</a></sup>
by launching other programs directly from Perl. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[1]</a></sup> Child processes,
that is.</p>
      </blockquote>
  
      <p class="docText">And like everything else in Perl, There's More Than
One Way To Do It, with lots of overlap, variations, and special features.
So if you don't like the first way, just read on for another page or two
for a solution more to your liking. </p>
  
      <p class="docText">Perl is very portable; most of the rest of this
book doesn't need many notes saying that it works this way on Unix systems
and that way on Windows and the other way on VMS. But when you're starting
other programs on your machine, different programs are available on a Macintosh
than you'll likely find on a Cray. The examples in this chapter are primarily
Unix-based; if you have a non-Unix system, you can expect to see some differences. 
      </p>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
 
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-14-SECT-1"></a> 
      <h3 class="docSection1Title">14.1 The system Function</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-951"></a>The simplest way
to launch a child process in Perl to run a program is the <tt><font
 color="#cc0000">system</font></tt> function. For example, to invoke the
Unix <i>date</i><a name="IXT-14-336522"></a> command from within Perl, it
looks like: </p>
  
      <pre><font color="#cc0000">system "date";</font></pre>
  
      <p class="docText">The child process runs the <i>date</i> command,
which inherits Perl's standard input, standard output, and standard error.
This mean that the normal short date-and-time string generated by <i>date</i>
ends up wherever Perl's <tt><font color="#cc0000">STDOUT</font></tt> was
already going. </p>
  
      <p class="docText">The parameter to the system function is generally
whatever you'd normally type at the shell. So if it were a more complicated
command, like "<span class="docEmphasis">ls -l $HOME</span> ", we'd just
have put all that into the parameter: </p>
  
      <pre><font color="#cc0000">system 'ls -l $HOME';</font></pre>
  
      <p class="docText">Note that we had to switch here from double quotes
to single quotes, since <tt><font color="#cc0000">$HOME</font></tt> is the
shell's variable. Otherwise, the shell would never have seen the dollar sign,
since that's also an indicator for Perl to interpolate. Alternatively, we
could write: </p>
  
      <pre><font color="#cc0000">system "ls -l \$HOME";</font></pre>
  
      <p class="docText">But that can get quickly unwieldly.</p>
  
      <p class="docText">Now, the <i>date</i> command is output-only, but 
let's say it had been a chatty command, asking first "for which time zone
do you want the time?"<sup class="docFootnote"><a class="docLink"
 href="#">[2]</a></sup> That'll end up on standard output, and then the program
will listen on standard input (inherited from Perl's <tt><font
 color="#cc0000">STDIN</font></tt>) for the response. You'll see the question,
and type in the answer (like "Zimbabwe time"), and then <i>date</i> will finish
its duty. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[2]</a></sup> As far as we
know, no one has made a <i>date</i> command that works like this.</p>
      </blockquote>
  
      <p class="docText">While the child process is running, Perl is patiently
waiting for it to finish. So if the <i>date</i> command took 37 seconds, then
Perl is paused for those 37 seconds. You can use the shell's facility to
launch a background process,<sup class="docFootnote"><a class="docLink"
 href="#">[3]</a></sup> however: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[3]</a></sup> See what we
mean about this depending upon your system? The Unix shell (<i>/bin/sh</i>)
lets you use the ampersand on this kind of command to make a background process.
If your non-Unix system doesn't support this way to launch a background process, 
then you can't do it this way, that's all.</p>
      </blockquote>
  
      <pre><font color="#cc0000">system "long_running_command with parameters &amp;";</font></pre>
  
      <p class="docText">Here, the shell gets launched, which then notices
the ampersand at the end of the command line, causing the <i>long_running_command</i>
to be made into a background process. And then the shell exits rather quickly,
which Perl notices and moves on. In this case, the <i>long_running_command</i>
is really a grandchild of the Perl process, to which Perl really has no direct
access or knowledge. </p>
  
      <p class="docText">When the command is "simple enough," no shell gets 
involved, so for the <i>date</i> and <i>ls</i> commands earlier, the requested
command is launched directly by Perl, which searches the inherited <tt><font
 color="#cc0000">PATH<sup class="docFootnote"><a class="docLink"
 href="#">[4]</a></sup></font></tt> to find the command, if necessary. But
if there's anything weird in the string (such as shell metacharacters like
the dollar sign, semicolon, or vertical bar), then the standard Bourne Shell
(<span class="docEmphasis">/bin/sh<sup class="docFootnote"><a
 class="docLink" href="#">[5]</a></sup></span>) gets invoked to work through
the complicated stuff. In that case, the shell is the child process, and
the requested commands are grandchildren (or further offspring). For example,
you can write an entire little shell script in the argument: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[4]</a></sup> The <tt><font
 color="#cc0000">PATH</font></tt> can be changed by adjusting <tt><font
 color="#cc0000">$ENV{'PATH'}</font></tt> at any time. Initially, this is
the environment variable inherited from the parent process (usually the shell).
Changing this value affects new child processes, but cannot affect any preceding
parent processes. The <tt><font color="#cc0000">PATH</font></tt> is the list
of directories where executable programs (commands) are found, even on some
non-Unix systems.</p>
      </blockquote>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[5]</a></sup> Or whatever
was determined when Perl was built. Practically always, this is just <span
 class="docEmphasis">/bin/sh</span> on Unix-like systems.</p>
      </blockquote>
  
      <pre><font color="#cc0000">system 'for in *; do echo == $i ==; cat $i; done';</font></pre>
  
      <p class="docText">Here again, we're using single quotes, because the
dollar signs here are meant for the shell and not for Perl. Double quotes
would have permitted Perl to expand <tt><font color="#cc0000">$i</font></tt>
to its current Perl value, and not let the shell expand it to its own value.<sup
 class="docFootnote"><a class="docLink" href="#">[6]</a></sup> By the way,
that little shell script goes through all of the normal files in the current
directory, printing out each one's name and contents; you can try it out yourself
if you don't believe us. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[6]</a></sup> Of course, if
you set <tt><font color="#cc0000">$i = '$i'</font></tt>, then it would work
anyway, until a maintenance programmer came along and "fixed" that line out
of existence. </p>
      </blockquote>
  <a name="lperl3-CHP-14-SECT-1.1"></a> 
      <h4 class="docSection2Title">14.1.1 Avoiding the Shell</h4>
  
      <p class="docText">The system operator may also be invoked with more
than one argument,<sup class="docFootnote"><a class="docLink" href="#">[7]</a></sup>
in which case a shell doesn't get involved, no matter how complicated the
text: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[7]</a></sup> Or with a parameter
in the indirect-object slot, like <tt><font color="#cc0000">system { 'fred'
} 'barney';</font></tt>, which runs the program <tt><font
 color="#cc0000">barney</font></tt>, but lies to it so it thinks that it's
called <tt><font color="#cc0000">'fred'</font></tt>. See the <span
 class="docEmphasis">perlfunc</span> manpage.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my $tarfile = "something*wicked.tar";<br>my @dirs = qw(fred|flintstone &lt;barney&amp;rubble&gt; betty );<br>system "tar", "cvf", $tarfile, @dirs;</font></pre>
  
      <p class="docText">In this case, the first parameter (<tt><font
 color="#cc0000">"tar"</font></tt> here) gives the name of a command found
in the normal <tt><font color="#cc0000">PATH</font></tt>-searching way, while
the remaining arguments are passed, one by one, directly to that command.
Even if the arguments have <a name="IXT-14-336523"></a>shell-significant
characters, such as the name in <tt><font color="#cc0000">$tarfile</font></tt>
or the directory names in <tt><font color="#cc0000">@dirs</font></tt>, the
shell never gets a chance to mangle the string. So that <tt><font
 color="#cc0000">tar</font></tt> command will get precisely five parameters.
Compare this with: </p>
  
      <pre><font color="#cc0000">system "tar cvf $tarfile @dirs";  # Oops!</font></pre>
  
      <p class="docText">Here, we've now piped a bunch of stuff into a <i>flintstone</i>
command and put it into the background, and opened <i>betty</i> for output. 
      </p>
  
      <p class="docText">And that's a bit scary,<sup class="docFootnote"><a
 class="docLink" href="#">[8]</a></sup> especially if those variables are
from user input&#8212;such as from a web form or something. So, if you <span
 class="docEmphasis">can</span> arrange things so that you can use the multiple-argument
version of <tt><font color="#cc0000">system</font></tt>, you probably should
use that way to launch your subprocess. (You'll have to give up the ability
to have the shell do the work for you to set up I/O redirection, background
processes, and the like, though. There's no such thing as a free launch.) 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[8]</a></sup> Unless you're 
using taint checking and have done all the right things to prescan your data
to ensure that the user isn't trying to pull a fast one on you.</p>
      </blockquote>
  
      <p class="docText">Note that redundantly, a single argument invocation
of <tt><font color="#cc0000">system</font></tt> is nearly equivalent to the
proper multiple-argument version of <tt><font color="#cc0000">system</font></tt>: 
      </p>
  
      <pre><font color="#cc0000">system $command_line;<br>system "/bin/sh", "-c", $command_line;</font></pre>
  
      <p class="docText">But nobody writes the latter, unless you want things
to be processed by a different shell, like the C-shell: </p>
  
      <pre><font color="#cc0000">system "/bin/csh", "-fc", $command_line;</font></pre>
  
      <p class="docText">Even this is pretty rare, since the One True Shell<sup
 class="docFootnote"><a class="docLink" href="#">[9]</a></sup> seems to have
a lot more flexibility, especially for scripted items. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[9]</a></sup> That's <span
 class="docEmphasis">/bin/sh</span>, or whatever your Unix system has installed
as the most Bourne-like shell. If you don't have a One True Shell, Perl figures
out how to invoke some other command-line interpreter, with notable consequences&#8212;noted,
that is, in the documentation for that Perl port.</p>
      </blockquote>
  
      <p class="docText">The return value of the system operator is based
upon the exit status of the child command<sup class="docFootnote"><a
 class="docLink" href="#">[10]</a></sup>. In Unix, an exit value of <tt><font
 color="#cc0000">0</font></tt> means that everything is OK, and a non-zero
exit value usually indicates that something went wrong: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[10]</a></sup> It's actually
the "wait" status, which is the child exit code times 256, plus 128 if core
was dumped, plus the signal number triggering termination, if any. But we
rarely check the specifics of that, and a simple true/false value suffices
for nearly all applications.</p>
      </blockquote>
  
      <pre><font color="#cc0000">unless (system "date") {<br>  # Return was zero - meaning success<br>  print "We gave you a date, OK!\n";<br>}</font></pre>
  
      <p class="docText">Note that this is backward from the normal "true
is good&#8212;false is bad" strategy for most of the operators, so to write a typical
"do this or die" style, we'll need to flip false and true. The easiest way
is to simply prefix the <tt><font color="#cc0000">system</font></tt> operator
with a bang (the logical-not operator): </p>
  
      <pre><font color="#cc0000">!system "rm -rf files_to_delete" or die "something went wrong";</font></pre>
  
      <p class="docText">In this case, including <tt><font
 color="#cc0000">$!</font></tt> in the error message would not be appropriate,
because the failure is most likely somewhere within the experience of the
      <i>rm</i> command, and it's not a system-call related error within
Perl that <tt><font color="#cc0000">$!</font></tt> can reveal.<a
 name="IXTR3-92"></a> </p>
    
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-14-SECT-2"></a> 
      <h3 class="docSection1Title">14.2 The exec Function</h3>
  
      <p class="docText">Everything we've just said about <tt><font
 color="#cc0000">system</font></tt> syntax and semantics is also true about
the <tt><font color="#cc0000">exec</font></tt><a name="IXT-14-336524"></a>
function, except for one (very important) thing. The <tt><font
 color="#cc0000">system</font></tt> function creates a child process, which
then scurries off to perform the requested action while Perl naps. The <tt><font
 color="#cc0000">exec</font></tt> function causes the Perl process <span
 class="docEmphasis">itself</span> to perform the requested action. Think
of it as more like a "goto" than a subroutine call. </p>
    
      <p class="docText">For example, suppose we wanted to run the <i>bedrock</i> 
command in the <i>/tmp</i> directory, passing it arguments of <span
 class="docEmphasis">-o args1</span> followed by whatever arguments our own
program was invoked with. That'd look like this: </p>
  
      <pre><font color="#cc0000">chdir "/tmp" or die "Cannot chdir /tmp: $!";<br>exec "bedrock", "-o", "args1", @ARGV;</font></pre>
  
      <p class="docText">When we reach the <tt><font color="#cc0000">exec</font></tt>
operation, Perl locates <i>bedrock</i>, and "jumps into it." At that point,
there is no Perl process any more,<sup class="docFootnote"><a
 class="docLink" href="#">[11]</a></sup> just the process running the <i>bedrock</i>
command. When <i>bedrock</i> is finished, there's no Perl to come back to,
so we'd get a prompt back if we invoked this program from the command line. 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[11]</a></sup> Actually, it's
the same process, having performed the Unix <tt><font color="#cc0000">exec(2)</font></tt>
system call (or equivalent). The process ID remains the same.</p>
      </blockquote>
  
      <p class="docText">Why is this useful? Well, if the purpose of this
Perl program were to set up a particular environment to run another program,
the purpose is fulfilled as soon as the other program has started. If we'd 
used <tt><font color="#cc0000">system</font></tt> instead of <tt><font
 color="#cc0000">exec</font></tt>, we'd have a Perl program just standing
around tapping its toes waiting for the other program to complete, just so
Perl could finally immediately exit as well, and that's a wasted resource. 
      </p>
  
      <p class="docText">Having said that, it's actually quite rare to use 
      <tt><font color="#cc0000">exec</font></tt>, except in combination with 
      <tt><font color="#cc0000">fork</font></tt> (which we'll see later).
If you are puzzling over <tt><font color="#cc0000">system</font></tt><a
 name="IXT-14-336525"></a> versus <tt><font color="#cc0000">exec</font></tt>, 
just pick <tt><font color="#cc0000">system</font></tt>, and nearly all of
the time, you'll be just fine. </p>
  
      <p class="docText">Because Perl is no longer in control once the requested
command has started, it doesn't make any sense to have any Perl code following
the <tt><font color="#cc0000">exec</font></tt>, except for handling the error
when the requested command cannot be started: </p>
  
      <pre><font color="#cc0000">exec "date";<br>die "date couldn't run: $!";</font></pre>
  
      <p class="docText">In fact, if you have warnings turned on, and if
you have any code after the <tt><font color="#cc0000">exec</font></tt> other
than a <tt><font color="#cc0000">die</font></tt>,<sup
 class="docFootnote"><a class="docLink" href="#">[12]</a></sup> you'll get
notified. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[12]</a></sup> Or exit. Or
if it's at the end of a block. This may change in a new release of Perl, too.</p>
      </blockquote>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-14-SECT-3"></a> 
      <h3 class="docSection1Title">14.3 The Environment Variables</h3>
  
      <p class="docText">When you're starting another process (with any of
the methods discussed here), you may need to set up its <a
 name="IXT-14-336526"></a> <a name="IXT-14-336527"></a>environment in one
way or another. As we mentioned earlier, you could start the process with
a certain working directory, which it inherits from your process. Another
common configuration detail is the environment variables. </p>
  
      <p class="docText">The best-known environment variable is <tt><font
 color="#cc0000">PATH</font></tt><a name="IXT-14-336528"></a>. (If you've
never heard of it, you probably haven't used a system that has environment 
variables.) On Unix and similar systems, <tt><font color="#cc0000">PATH</font></tt>
is a colon-separated list of directories that may hold programs. When you 
type a command like <i>rm fred</i>, the system will look for the <span
 class="docEmphasis">rm</span> command in that list of directories, in order.
Perl (or your system) will use <tt><font color="#cc0000">PATH</font></tt> 
whenever it needs to find the program to run. If the program in turn runs
other programs, those may also be found along the <tt><font
 color="#cc0000">PATH</font></tt>. (Of course, if you give a complete name
for a command, such as <span class="docEmphasis">/bin/echo</span>, there's
no need to search <tt><font color="#cc0000">PATH</font></tt>. But that's
generally much less convenient.) </p>
  
      <p class="docText">In Perl, the environment variables are available
via the special <tt><font color="#cc0000">%ENV</font></tt><a
 name="IXT-14-336529"></a> hash; each key in this hash represents one environment
variable. At the start of your program's execution, <tt><font
 color="#cc0000">%ENV</font></tt> holds values it has inherited from its
parent process (generally the shell). Modifying this hash changes the environment
variables, which will then be inherited by new processes and possibly used
by Perl as well. For example, suppose you wished to run the system's <tt><font
 color="#cc0000">make</font></tt> utility (which typically runs other programs),
and you want to use a private directory as the first place to look for commands
(including <tt><font color="#cc0000">make</font></tt> itself). And let's
say that you don't want the <tt><font color="#cc0000">IFS</font></tt> environment
variable to be set when you run the command, because that might cause <i>make</i>
or some subcommand do the wrong thing. Here we go: </p>
  
      <pre><font color="#cc0000">$ENV{'PATH'} = "/home/rootbeer/bin:$ENV{'PATH'}";<br>delete $ENV{'IFS'};<br>my $make_result = system "make";</font></pre>
  
      <p class="docText">Newly created processes will generally inherit from
their parent the environment variables, the current working directory, the
standard input, output, and error streams, and a few more-esoteric items.
See the documentation about programming on your system for more details. (But
your program can't change the environment for the shell or other parent process
that started it, on most systems.) </p>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-14-SECT-4"></a> 
      <h3 class="docSection1Title">14.4 Using Backquotes to Capture Output</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-961"></a> <a
 name="lperl3-IDXTERM-962"></a> <a name="lperl3-IDXTERM-963"></a>With <i></i><a
 name="lperl3-IDXTERM-964"></a>both <tt><font color="#cc0000">system</font></tt>
and <tt><font color="#cc0000">exec</font></tt>, the output of the launched
command ends up wherever Perl's standard output is going. Sometimes, it's 
interesting to capture that output as a string value to perform further processing.
And that's done simply by creating a string using backquotes instead of single
or double quotes: </p>
  
      <pre><font color="#cc0000">my $now = `date`;             # grab the output of date<br>print "The time is now $now"; # newline already present</font></pre>
  
      <p class="docText">Normally, this <i>date</i> command spits out a string 
approximately 30 characters long to its standard output, giving the current
date and time followed by a newline. When we've placed <i>date</i> between
backquotes, Perl executes the <i>date</i> command, arranging for its standard
output to be captured as a string value, and in this case assigned to the 
      <tt><font color="#cc0000">$now</font></tt><a name="IXT-14-336530"></a>
variable. </p>
  
      <p class="docText">This is very similar to the Unix shell's meaning
for backquotes. However, the shell also performs the additional job of ripping
off the final end-of-line to make it easier to use the value as part of other
things. Perl is honest; it gives the real output. To get the same result
in Perl, we can simply add an additional <tt><font color="#cc0000">chomp</font></tt>
operation on the result: </p>
  
      <pre><font color="#cc0000">chomp(my $no_newline_now = `date`);<br>print "A moment ago, it was $no_newline_now, I think.\n";</font></pre>
  
      <p class="docText">The value beween backquotes is just like the single-argument
form of system,<sup class="docFootnote"><a class="docLink" href="#">[13]</a></sup>
and is interpreted as a double-quoted string, meaning that backslash-escapes 
and variables are expanded appropriately.<sup class="docFootnote"><a
 class="docLink" href="#">[14]</a></sup> For example, to fetch the Perl documentation
on a list of Perl functions, we might invoke the <i>perldoc</i> command repeatedly, 
each time with a different argument: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[13]</a></sup> That is, it's
also always interpreted by the One True Shell (<span class="docEmphasis">/bin/sh</span>)
or alternative, as with <tt><font color="#cc0000">system</font></tt>.</p>
      </blockquote>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[14]</a></sup> So, if you want
to pass a real backslash to the shell, you'll need to use two. If you need
to pass two (which happens frequently on Windows systems), you'll need to
use four. </p>
      </blockquote>
  
      <pre><font color="#cc0000">my @functions = qw{ int rand sleep length hex eof not exit sqrt umask };<br>my %about;<br><br>foreach (@functions) {<br>  $about{$_} = `perldoc -t -f $_`;<br>}</font></pre>
  
      <p class="docText">Note that <tt><font color="#cc0000">$_</font></tt>
will be a different value for each invocation, letting us grab the output
of a different command varying only in one of its parameters. Also note that
if you haven't seen some of these functions yet, it might be useful to look
them up in the documentation to see what they do! </p>
  
      <p class="docText">There's no easy equivalent of single quotes for backquotes<sup
 class="docFootnote"><a class="docLink" href="#">[15]</a></sup> ; variable
references and backslash items are always expanded. Also, there's no easy
equivalent of the multiple-argument version of <tt><font color="#cc0000">system</font></tt>
(where a shell is never involved). If the command inside the backquotes is 
complex enough, a Unix Bourne Shell (or whatever your system uses instead)
is invoked to interpret the command automatically. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[15]</a></sup> For a couple
of harder ways, you can place your string inside <tt><font
 color="#cc0000">qx'...'</font></tt>delimiters, or you can put it all in
a variable using a single-quoted string, then interpolate <span
 class="docEmphasis">that</span> string into a backquoted string, since the
interpolation will be only one level.</p>
      </blockquote>
  
      <p class="docText">At the risk of actually introducing the behavior
by demonstrating how <span class="docEmphasis">not</span> to do it, we'd
also like to suggest that you avoid using backquotes in a place where the
value isn't being captured.<sup class="docFootnote"><a class="docLink"
 href="#">[16]</a></sup> For example: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[16]</a></sup> This is called
a "void" context.</p>
      </blockquote>
  
      <pre><font color="#cc0000">print "Starting the frobnitzigator:\n";<br>`frobnitz -enable`; # please don't do this!<br>print "Done!\n";</font></pre>
  
      <p class="docText">The problem is that Perl has to work a bit harder
to capture the output of this command, even when you're just throwing it
away, and then you also lose the option to use multiple arguments to <tt><font
 color="#cc0000">system</font></tt> to precisely control the argument list. 
So from both a security standpoint and an efficiency viewpoint, just use
      <tt><font color="#cc0000">system</font></tt> instead, please. </p>
  
      <p class="docText">Standard error of a backquoted command is inherited
from Perl's current standard error output. If the command spits out error 
messages to standard error, you'll probably see them on the terminal, which
could be confusing to the user who hasn't personally invoked the <i>frobnitz</i>
command. If you want to capture <a name="IXT-14-336531"></a>error messages
with standard output, you can use the shell's normal "merge standard error
to the current standard output," which is spelled <tt><font
 color="#cc0000">2&gt;&amp;1</font></tt> in the normal Unix shell: </p>
  
      <pre><font color="#cc0000">my $output_with_errors = `frobnitz -enable 2&gt;&amp;1`;</font></pre>
  
      <p class="docText">Note that this will make the standard error output
intermingled with the standard output, much as it appears on the terminal
(although possibly in a slightly different sequence because of buffering).
If you need the output and the error output separated, there are many harder-to-type
solutions.<sup class="docFootnote"><a class="docLink" href="#">[17]</a></sup> 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[17]</a></sup> Such as <tt><font
 color="#cc0000">IPC::Open3</font></tt> in the standard Perl library, or writing
your own forking code, as we will see later.</p>
      </blockquote>
  
      <p class="docText">Similarly, standard input is inherited from Perl's
current standard input. Most commands we typically use with backquotes do
not read standard input, so that's rarely a problem. However, let's say the
      <i>date</i> command asked which time zone (as we imagined earlier).
That'll be a problem, because the prompt for "which time zone" will be sent
to standard output, which is being captured as part of the value, and then
the <i>date</i> command will start trying to read from standard input. But
since the user has never seen the prompt, he or she doesn't know to be typing
anything! Pretty soon, the user calls you up and tells you that your program
is stuck. </p>
  
      <p class="docText">So, stay away from commands that read standard input.
If you're not sure whether something reads from standard input, then add
a redirection from <i>/dev/null</i> for input, like this: </p>
  
      <pre><font color="#cc0000">my $result = `some_questionable_command arg arg argh &lt;/dev/null`;</font></pre>
  
      <p class="docText">Then the child shell will redirect input from <i>/dev/null</i>,
and the grandchild questionable command will at worst try to read and immediately
get an end of file. </p>
  <a name="lperl3-CHP-14-SECT-4.1"></a> 
      <h4 class="docSection2Title">14.4.1 Using Backquotes in a List Context</h4>
  
      <p class="docText"><a name="lperl3-IDXTERM-967"></a>If the output from
a command has multiple lines, the scalar use of backquotes returns it as
a single long string containing newline characters. However, using the same 
backquoted string in a list context yields a list containing one line of
output per element. </p>
  
      <p class="docText">For example, the Unix <i>who</i><a
 name="IXT-14-336532"></a> command normally spits out a line of text for
each current login on the system as follows: </p>
  
      <pre><font color="#cc0000">merlyn     tty/42     Dec 7  19:41<br>rootbeer   console    Dec 2  14:15<br>rootbeer   tty/12     Dec 6  23:00</font></pre>
  
      <p class="docText">The left column is the username, the middle column
is the tty name (that is, the name of the user's connection to the machine), 
and the rest of the line is the date and time of login (and possibly remote
login information, but not in this example). In a scalar context, we get
all that at once, which we would then need to split up: </p>
  
      <pre><font color="#cc0000">my $who_text = `who`;</font></pre>
  
      <p class="docText">But in a list context, we automatically get the
data broken up by lines: </p>
  
      <pre><font color="#cc0000">my @who_lines = `who`;</font></pre>
  
      <p class="docText">We'll have a number of separate elements in <tt><font
 color="#cc0000">@who_lines</font></tt>, each one terminated by a newline.
Of course, adding a <tt><font color="#cc0000">chomp</font></tt> around the
outside of that will rip off those newlines, but let's go a different direction.
If we put that as part of the value for a <tt><font color="#cc0000">foreach</font></tt>,
we'll iterate over the lines automatically, placing each one in <tt><font
 color="#cc0000">$_</font></tt>: </p>
  
      <pre><font color="#cc0000">foreach (`who`) {<br>  my($user, $tty, $date) = /(\S+)\s+(\S+)\s+(.*)/;<br>  $ttys{$user} .= "$tty at $date\n";<br>}</font></pre>
  
      <p class="docText">This loop will iterate three times for the data
above. (Your system will probably have more than three active logins at any
given time.) Notice that we've got a regular expression match, and in the 
absence of the binding operator ("<tt><font color="#cc0000">=~"</font></tt>), 
that's matching against <tt><font color="#cc0000">$_</font></tt>, which is
good because that's where the data is. </p>
  
      <p class="docText">Also notice the regular expression is looking for
a nonblank word, some whitespace, a nonblank word, some whitespace, and then
the rest of the line up to, but not including, the newline (since dot doesn't
match newline by default).<sup class="docFootnote"><a class="docLink"
 href="#">[18]</a></sup> That's also good, because that's what the data looks
like each time in <tt><font color="#cc0000">$_</font></tt>. That'll make
      <tt><font color="#cc0000">$1</font></tt> be "<tt><font
 color="#cc0000">merlyn</font></tt>", <tt><font color="#cc0000">$2</font></tt>
be "<tt><font color="#cc0000">tty/42</font></tt>", and <tt><font
 color="#cc0000">$3</font></tt> be "<tt><font color="#cc0000">Dec 7 19:41</font></tt>",
as a successful match on the first time through the loop. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[18]</a></sup> Now you can 
see <span class="docEmphasis">why</span> dot doesn't match newline by default.
It makes it easy to write patterns like this one, in which we don't have
to worry about a newline at the end of the string.</p>
      </blockquote>
  
      <p class="docText">However, this regular expression match is in a list
context, so instead of returning back a true/false value (as when you have
a regular expression match in a scalar context), we take the memory variables
and bundle them up in sequence as a list. In this case, the right side of
that assignment is thus a three-element list, which happens to correspond
to the three elements of the literal list on the left, and we get those nice
corresponding assignments. So, <tt><font color="#cc0000">$user</font></tt>
ends up being <tt><font color="#cc0000">"merlyn"</font></tt>, and so on. </p>
  
      <p class="docText">The second statement inside the loop simply stores
away the tty and date information, appending to a (possibly <tt><font
 color="#cc0000">undef</font></tt>) value in the hash, because a user might
be logged in more than once, as user <tt><font color="#cc0000">"rootbeer"</font></tt>
was in<a name="IXTR3-93"></a> our example.<a name="IXTR3-94"></a> <a
 name="IXTR3-95"></a> <a name="IXTR3-96"></a> </p>
    <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-14-SECT-5"></a> 
      <h3 class="docSection1Title">14.5 Processes as Filehandles</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-973"></a> <a
 name="lperl3-IDXTERM-974"></a>So far, we've been looking at ways to deal
with synchronous processes, where Perl stays in charge, launches a command,
(usually) waits for it to finish, then possibly grabs its output. But Perl
can also launch a child process that stays alive, communicating<sup
 class="docFootnote"><a class="docLink" href="#">[19]</a></sup> to Perl on
an ongoing basis until the task is complete. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[19]</a></sup> Via pipes,
or whatever your operating system provides for simple interprocess communication.</p>
      </blockquote>
  
      <p class="docText">The syntax for launching a concurrent (parallel)
child process is to put the command as the "filename" for an <tt><font
 color="#cc0000">open</font></tt> call, and either precede the command or 
follow the command with a vertical bar, which is the "pipe" character. For
that reason, this is often called a <a name="IXT-14-336533"></a> <a
 name="IXT-14-336534"></a><i>piped open</i>: </p>
  
      <pre><font color="#cc0000">open DATE, "date|" or die "cannot pipe from date: $!";<br>open MAIL, "|mail merlyn" or die "cannot pipe to mail: $!";</font></pre>
  
      <p class="docText">In the first example, with the vertical bar on the
right, the command is launched with its standard output connected to the <tt><font
 color="#cc0000">DATE</font></tt> filehandle opened for reading, similar
to the way that the command <i>date | your_program</i> would work from the
shell. In the second example, with the vertical bar on the left, the command's
standard input is connected to the <tt><font color="#cc0000">MAIL</font></tt>
filehandle opened for writing, similar to what happens with the command <i>your_program
| mail merlyn</i>. In either case, the command is now launched and continues
independently of the Perl process.<sup class="docFootnote"><a
 class="docLink" href="#">[20]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[20]</a></sup> If the Perl
process exits before the command is complete, a command that's been reading
will see end-of-file, while a command that's been writing will get a "broken
pipe" error signal on the next write, by default.</p>
      </blockquote>
  
      <p class="docText">The open fails if the child process cannot be created.
If the command itself does not exist or exits erroneously, this will (generally)
not be seen as an error when opening, but as an error when closing. We'll
get to that in a moment. </p>
  
      <p class="docText">For all intents and purposes, the rest of the program
doesn't know, doesn't care, and would have to work pretty hard to figure
out that this is a filehandle opened on a process rather than on a file.
So, to get data from a filehandle opened for reading, we'll just do the normal
read: </p>
  
      <pre><font color="#cc0000">my $now = &lt;DATE&gt;;</font></pre>
  
      <p class="docText">And to send data to the mail process (waiting for
the body of a message to deliver to <span class="docEmphasis">merlyn</span>
on standard input), a simple print-with-a-filehandle will do: </p>
  
      <pre><font color="#cc0000">print MAIL "The time is now $now"; # presume $now ends in newline</font></pre>
  
      <p class="docText">In short, you can pretend that these filehandles
are hooked up to magical files, one that contains the output of the <i>date</i>
command, and one that will automatically be mailed by the <i>mail</i> command. 
      </p>
  
      <p class="docText">If a process is connected to a filehandle that is
open for reading, and then exits, the filehandle returns end-of-file, just
like reading up to the end of a normal file. When you close a filehandle
open for writing to a process, the process will see end-of-file. So, to finish 
sending the email, close the handle: </p>
  
      <pre><font color="#cc0000">close MAIL;<br>die "mail: non-zero exit of $?" if $?;</font></pre>
  
      <p class="docText">Closing a filehandle attached to a process waits
for the process to complete, so that Perl can get the process's exit status.
The exit status is then available in the <tt><font color="#cc0000">$?</font></tt>
variable (reminiscent of the same variable in the Bourne Shell), and is the 
same kind of number as the value returned by the <tt><font
 color="#cc0000">system</font></tt> function: zero for success, nonzero for 
failure. Each new exited process overwrites the previous value though, so
save it quickly if you want it. (The <tt><font color="#cc0000">$?</font></tt> 
variable also holds the exit status of the most recent <tt><font
 color="#cc0000">system</font></tt> or backquoted command, if you're curious.) 
      </p>
  
      <p class="docText">The processes are synchronized just like a pipelined
command. If you try to read and no data is available, the process is suspended 
(without consuming additional CPU time) until the sending program has started
speaking again. Similarly, if a writing process gets ahead of the reading
process, the writing process is slowed down until the reader starts to catch
up. There's a buffer (usually 4K bytes or so) in between so they don't have
to stay precisely in lock step. </p>
  
      <p class="docText">Why use processes as filehandles? Well, it's the
only easy way to write to a process based on the results of a computation.
But if you're just reading, backquotes are often much easier to manage, unless
you want to have the results as they come in. </p>
  
      <p class="docText">For example, the Unix <i>find</i><a
 name="IXT-14-336535"></a> command locates files based on their attributes,
and it can take quite a while if used on a fairly large number of files (such
as starting from the <span class="docEmphasis">root</span> directory). You
can put a <i>find</i> command inside backquotes, but it's often nicer to
see the results as they are found: </p>
  
      <pre><font color="#cc0000">open F, "find / -atime +90 -size +1000 -print|" or die "fork: $!";<br>while (&lt;F&gt;) {<br>  chomp;<br>  printf "%s size %dK last accessed on %s\n",<br>    $_, (1023 + -s $_)/1024, -A $_;<br>}</font></pre>
  
      <p class="docText">The <i>find</i> command here is looking for all
the files that were not accessed within the past 90 days and that are larger 
than 1000 blocks. (These are good candidates to be moved off to longer-term
storage.) While <i>find</i> is searching and searching, Perl can wait. As
each file is found, Perl responds to the incoming name and displays some
information about that file for further research. Had this been written with
backquotes, we'd not see any output until the <i>find</i> commmand had finished,
and it's comforting to see that it's actually doing the job even before it's<i></i><a
 name="IXTR3-97"></a> done.<a name="IXTR3-98"></a> <a name="IXTR3-99"></a> 
      </p>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-14-SECT-6"></a> 
      <h3 class="docSection1Title">14.6 Getting Down and Dirty with Fork</h3>
  
      <p class="docText">In addition to the high-level interfaces already
described, Perl provides nearly direct access to the low-level process management 
system calls of Unix and some other systems. If you've never done this before,<sup
 class="docFootnote"><a class="docLink" href="#">[21]</a></sup> you will
probably want to skip this section. While it's a bit much to cover all that
stuff in a chapter like this, let's at least look at a quick reimplementation
of this: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[21]</a></sup> Or you're not
running on a system that has support for forking. But the Perl developers
are working hard to add forking even on systems whose underlying process model
is very different than the one in Unix.</p>
      </blockquote>
  
      <pre><font color="#cc0000">system "date";</font></pre>
  
      <p class="docText">Let's look at how that would be done using the low-level
system calls: </p>
  
      <pre><font color="#cc0000">defined(my $pid = fork) or die "Cannot fork: $!";<br>unless ($pid) {<br>  # Child process is here<br>  exec "date";<br>  die "cannot exec date: $!";<br>}<br># Parent process is here<br>waitpid($pid, 0);</font></pre>
  
      <p class="docText">Here, we've checked the return value from <a
 name="IXT-14-336536"></a><tt><font color="#cc0000">fork</font></tt>, which
will be <tt><font color="#cc0000">undef</font></tt> if it failed. Usually
it will succeed, causing two separate processes to continue to the next line,
but only the parent process has a nonzero value in <tt><font
 color="#cc0000">$pid</font></tt>, so only the child process executes the
      <tt><font color="#cc0000">exec</font></tt> function. The parent process
skips over that and executes the <tt><font color="#cc0000">waitpid</font></tt><a
 name="IXT-14-336537"></a> function, waiting for that particular child to
finish (if others finish in the meantime, they are ignored). If that all
sounds like gobbledygook, just remember that you can continue to use the
      <tt><font color="#cc0000">system</font></tt> function without being
laughed at by your friends. </p>
  
      <p class="docText">When you go to this extra trouble, you also have
full control over arbitary pipe creation, rearranging filehandles, and noticing
your process ID and your parent's process ID (if knowable). But again, that's
all a bit complicated for this chapter, so see the details in the <span
 class="docEmphasis">perlipc</span><a name="IXT-14-336538"></a> manpage (and
in any good book on application programming on your system) for further information. 
      </p>
   
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-14-SECT-7"></a> 
      <h3 class="docSection1Title">14.7 Sending and Receiving Signals</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-984"></a> <a
 name="lperl3-IDXTERM-985"></a>A Unix signal is a tiny message sent to a
process. It can't say much; it's like a car horn honking&#8212;does that honk you
hear mean "look out&#8212;the bridge collapsed" or "the light has changed&#8212;get going"
or "stop driving&#8212;you've got a baby on the roof" or "hello, world"? Well,
fortunately, Unix signals are a little easier to interpret than that, because
there's a different one for each of these situations.<sup
 class="docFootnote"><a class="docLink" href="#">[22]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[22]</a></sup> Well, not exactly
these situations, but analogous Unix-like ones. For these, the signals are
        <tt><font color="#cc0000">SIGHUP</font></tt>, <tt><font
 color="#cc0000">SIGCONT</font></tt>, <tt><font color="#cc0000">SIGINT</font></tt>,
and the fake <tt><font color="#cc0000">SIGZERO</font></tt> (signal number
zero).</p>
      </blockquote>
  
      <p class="docText">Different signals are identified by a name (such
as <tt><font color="#cc0000">SIGINT</font></tt><a name="IXT-14-336539"></a>, 
meaning "interrupt signal") and a corresponding small integer (in the range
from 1 to 16, 1 to 32, or 1 to 63, depending on your Unix flavor). Signals
are typically sent when a significant event happens, such as pressing the
interrupt character (typically Control-C) on the terminal, which sends a
      <tt><font color="#cc0000">SIGINT</font></tt> to all the processes attached
to that terminal.<sup class="docFootnote"><a class="docLink" href="#">[23]</a></sup>
Some signals are sent automatically by the system, but they can also come
from another process. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[23]</a></sup> And you thought
that pressing Control-C stopped your program. Actually, it simply sends the
        <tt><font color="#cc0000">SIGINT</font></tt> signal, and that stops 
the program by default. As we'll see later in this chapter, you can make
a program that does something different when <tt><font color="#cc0000">SIGINT</font></tt>
comes in, rather than stopping at once.</p>
      </blockquote>
  
      <p class="docText">You can send signals from your Perl process to another
process, but you have to know the target's process ID number. How to figure 
that out is a bit complicated,<sup class="docFootnote"><a
 class="docLink" href="#">[24]</a></sup> but let's say you know that you
want to send a <tt><font color="#cc0000">SIGINT</font></tt> to process 4201.
That's easy enough: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[24]</a></sup> Usually you
have the process ID because it's a child process you produced with <tt><font
 color="#cc0000">fork</font></tt>, or you found it in a file or from an external
program. Using an external program can be difficult and problematic, which
is why many long-running programs save their own current process ID into
a file, usually described in the program's documentation.</p>
      </blockquote>
  
      <pre><font color="#cc0000">kill 2, 4201 or die "Cannot signal 4201 with SIGINT: $!";</font></pre>
  
      <p class="docText">It's named "kill" because one of the primary purposes
of signals is to stop a process that's gone on long enough. You can also
use the string <tt><font color="#cc0000">'INT'</font></tt> in place of the
      <tt><font color="#cc0000">2</font></tt> there, because signal number 
      <tt><font color="#cc0000">2</font></tt> is <tt><font
 color="#cc0000">SIGINT</font></tt>. If the process no longer exists,<sup
 class="docFootnote"><a class="docLink" href="#">[25]</a></sup> you'll get
a false return value, so you can also use this technique to see whether a
process is still alive. A special signal number of <tt><font
 color="#cc0000">0</font></tt> says "just check to see whether I <span
 class="docEmphasis">could</span> send a signal if I wanted to, but I don't
want to, so don't actually send anything." So a process probe might look
like: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[25]</a></sup> Sending a signal
will also fail if you're not the superuser and it's someone else's process.
It would be rude to send <tt><font color="#cc0000">SIGINT</font></tt> to someone
else's programs, anyway.</p>
      </blockquote>
  
      <pre><font color="#cc0000">unless (kill 0, $pid) {<br>  warn "$pid has gone away!";<br>}</font></pre>
  
      <p class="docText">Perhaps a little more interesting than sending signals
is catching signals. Why might you want to do this? Well, suppose you have
a program that creates files in<i> /tmp</i>, and you normally delete those
files at the end of the program. If someone presses Control-C during the
execution, that leaves trash in <i>/tmp</i>, a very unpolite thing to do.
To fix this, create a signal handler that takes care of the cleanup: </p>
  
      <pre><font color="#cc0000">my $temp_directory = "/tmp/myprog.$$"; # create files below here<br>mkdir $temp_directory, 0700 or die "Cannot create $temp_directory: $!";<br><br>sub clean_up {<br>  unlink glob "$temp_directory/*";<br>  rmdir $temp_directory;<br>}<br><br>sub my_int_handler {<br>  &amp;clean_up;<br>  die "interrupted, exiting...\n";<br>}<br><br>$SIG{'INT'} = 'my_int_handler';<br>.<br>.   # Time passes, the program runs, creates some temporary<br>.   # files in the temp directory, maybe somone presses Control-C<br>.<br># Now it's the end of normal execution<br>&amp;clean_up;</font></pre>
  
      <p class="docText">The assignment into the special <tt><font
 color="#cc0000">%SIG</font></tt> hash activates the handler (until revoked).
The key is the name of the signal (without the constant SIG prefix), and
the value is a string<sup class="docFootnote"><a class="docLink"
 href="#">[26]</a></sup> naming the subroutine, without the ampersand. From
then on, if a <tt><font color="#cc0000">SIGINT</font></tt> comes along, Perl
stops whatever it's doing and jumps immediately to the subroutine. Our subroutine
cleans up the <a name="IXT-14-336540"></a>temp files and then exits. (And
if nobody presses Control-C, we'll still call <tt><font color="#cc0000">&amp;clean_up</font></tt>
at the end of normal execution.) </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[26]</a></sup> The value can
also be a subroutine reference, but we're not doing those here.</p>
      </blockquote>
  
      <p class="docText">If the subroutine returns rather than exiting, execution
resumes right where it was interrupted. This can be useful if the interrupt 
needs to actually interrupt something rather than causing it to stop. For
example, suppose processing each line of a file takes a few seconds, which
is pretty slow, and you want to abort the overall processing when an interrupt
is processed, but not in the middle of processing a line. Just set a flag
in the interrupt procedure, and check it at the end of each line's processing: 
      </p>
  
      <pre><font color="#cc0000">my $int_count;<br>sub my_int_handler { $int_count++ }<br>$SIG{'INT'} = 'my_int_handler';<br>...<br>$int_count = 0;<br>while (&lt;SOMEFILE&gt;) {<br>  ... some processing that takes a few seconds ...<br>  if ($int_count) {<br>    # interrupt was seen!<br>    print "[processing interrupted...]\n";<br>    last;<br>  }<br>}</font></pre>
  
      <p class="docText">Now as each line is processed, the value of <tt><font
 color="#cc0000">$int_count</font></tt> will be <tt><font
 color="#cc0000">0</font></tt> if no one has pressed Control-C, and so the
loop continues to the next item. However, if an interrupt comes in, the interrupt
handler increments the <tt><font color="#cc0000">$int_count</font></tt> flag,
breaking out of the loop when checked at the end. </p>
  
      <p class="docText">So, you can either set a flag or break out of the
program, and that covers most of what you'll need from catching signals.
The current implementation of signal handlers is not entirely without faults,<sup
 class="docFootnote"><a class="docLink" href="#">[27]</a></sup> however,
so keep the stuff you're doing in there to an absolute minimum, or your program
may end up blowing up sometime when you least expect it.<a
 name="IXTR3-100"></a> <a name="IXTR3-101"></a> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[27]</a></sup> This is one
of the top items on the Perl developers' list of things to be fixed, so we
expect reliable signal handling to be one of the first items on the new feature
list for Perl 6. The problem is that a signal may come in at any time, even
when Perl isn't ready for one. If Perl is (for example) in the middle of
allocating some memory when a signal comes in, the signal handler can accidentally
try to allocate some memory and&#8212;your program is dead. You can't control when
your Perl code will allocate memory, but XSUB code (usually written in C) 
can safely handle signals. See the Perl documentation for more information
about this advanced topic.</p>
      </blockquote>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-14-SECT-8"></a> 
      <h3 class="docSection1Title">14.8 Exercises</h3>
  
      <p class="docText">See <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-APP-A-SECT-13#lperl3-APP-A-SECT-13">Section
A.13</a> for answers to the following exercises: </p>
  <span style="font-weight: bold;">
      <ol class="docList" type="1">
 <li><span style="font-weight: normal;">
          <p class="docList">[6] Write a program that changes to some particular
(hardcoded) directory, like the system's <span class="docEmphasis">root</span> 
directory, then executes the <i>ls -l</i> command to get a long-format directory
listing in that directory. (If you use a non-Unix system, use your own system's
command to get a detailed directory listing.) </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[10] Modify the previous program to send the
output of the command to a file called <i>ls.out</i> in the current directory. 
The error output should go to a file called <i>ls.err</i>. (You don't need
to do anything special about the fact that either of these files may end
up being empty.) </p>
          </span></li>
 <li><span style="font-weight: normal;">
          <p class="docList">[8] Write a program to parse the output of the 
          <i>date</i> command to determine the current day of the week. If
the day of the week is a weekday, print <tt><font color="#cc0000">get to work</font></tt>,
otherwise print <tt><font color="#cc0000">go play</font></tt>. The output
of the <i>date</i> command begins with <tt><font color="#cc0000">Mon</font></tt>
on a Monday.<sup class="docFootnote"><a class="docLink" href="#">[28]</a></sup>
If you don't have a <i>date</i> command on your non-Unix system, make a fake
little program that simply prints a string like <i>date</i> might print.
We'll even give you this two-line program if you promise not to ask us how 
it works<a name="IXTR3-102"></a><a name="IXTR3-103"></a><a
 name="IXTR3-104"></a>: </p>
 
          <blockquote>
            <p class="docFootnote"><sup><a name="">[28]</a></sup> At least
when the days of the week are being given in English. You might have to adjust 
accordingly if that's not the case on your system.</p>
          </blockquote>
 
          <pre><font color="#cc0000">#!/usr/bin/perl<br>print localtime( ) . "\n";</font></pre>
          </span></li>
 
      </ol>
      </span>  
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-15"></a>  
      <h2 class="docChapterTitle">Chapter 15. Strings and Sorting</h2>
  
      <p class="docText"><a name="lperl3-IDXTERM-990"></a>As we mentioned
near the beginning of this book, Perl is designed to be good at solving programming
problems that are about 90% working with text and 10% everything else. So
it's no surprise that Perl has strong text processing abilities, including
all that we've done with regular expressions. But sometimes the regular expression
engine is too fancy, and you'll need a simpler way of working with a string,
as we'll see in this chapter. </p>
   
      <ul>
      </ul>
 </td>
 </tr>
  </tbody>
</table>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-15-SECT-1"></a> 
      <h3 class="docSection1Title">15.1 Finding a Substring with index</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-991"></a>Finding a substring
depends on where you have lost it. If you happen to have lost it within a
bigger string, you're in luck, because the <tt><font color="#cc0000">index</font></tt><a
 name="IXT-15-336541"></a> <a name="IXT-15-336542"></a> function can help
you out. Here's how it looks: </p>
  
      <pre><font color="#cc0000">$where = index($big, $small);</font></pre>
  
      <p class="docText">Perl locates the first occurrence of the small string
within the big string, returning an integer location of the first character.
The character position returned is a zero-based value&#8212;if the substring is
found at the very beginning of the string, <tt><font color="#cc0000">index</font></tt>
returns <tt><font color="#cc0000">0</font></tt>. If it's one character later,
the return value is <tt><font color="#cc0000">1</font></tt>, and so on. If
the substring can't be found at all, the return value is <tt><font
 color="#cc0000">-1</font></tt> to indicate that.<sup
 class="docFootnote"><a class="docLink" href="#">[1]</a></sup> In this example,
      <tt><font color="#cc0000">$where</font></tt> gets <tt><font
 color="#cc0000">6</font></tt>: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[1]</a></sup> Former C programmers
will recognize this as being like C's index function. Current C programmers
ought to recognize it as well&#8212;but by this point in the book, you should really
be a <span class="docEmphasis">former</span>  C programmer.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my $stuff = "Howdy world!";<br>my $where = index($stuff, "wor");</font></pre>
  
      <p class="docText">Another way you could think of the position number
is the number of characters to skip over before getting to the substring.
Since <tt><font color="#cc0000">$where</font></tt> is <tt><font
 color="#cc0000">6</font></tt>, we know that we have to skip over the first
six characters of <tt><font color="#cc0000">$stuff</font></tt> before we
find <tt><font color="#cc0000">wor</font></tt>. </p>
  
      <p class="docText">The <tt><font color="#cc0000">index</font></tt>
function will always report the location of the <span
 class="docEmphasis">first found</span><a name="IXT-15-336543"></a> occurrence
of the substring. But you can tell it to start searching at a later point 
than the start of the string by using the optional third parameter, which
tells <tt><font color="#cc0000">index</font></tt> to start at that position: 
      </p>
  
      <pre><font color="#cc0000">my $stuff  = "Howdy world!";<br>my $where1 = index($stuff, "w");               # $where1 gets 2<br>my $where2 = index($stuff, "w", $where1 + 1);  # $where2 gets 6<br>my $where3 = index($stuff, "w", $where2 + 1);  # $where3 gets -1 (not found)</font></pre>
  
      <p class="docText">(Of course, you wouldn't normally search repeatedly
for a substring without using a loop.) That third parameter is effectively 
giving a minimum value for the return value; if the substring can't be found
at that position or later, the return value will be <tt><font
 color="#cc0000">-1</font></tt>. </p>
  
      <p class="docText">Once in a while, you might prefer to have the <span
 class="docEmphasis">last found</span><a name="IXT-15-336544"></a> occurrence
of the substring.<sup class="docFootnote"><a class="docLink" href="#">[2]</a></sup>
You can get that with the <tt><font color="#cc0000">rindex</font></tt><a
 name="IXT-15-336545"></a> function. In this example, we can find the last
slash, which turns out to be at position <tt><font color="#cc0000">4</font></tt>
in a string: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[2]</a></sup> Well, it's not
really the last one found&#8212;Perl cleverly starts searching from the other end
of the string, and then returns the first location it finds, which amounts
to the same result. Of course, the return value is the same zero-based number
as we always use for describing locations of substrings.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my $last_slash = rindex("/etc/passwd", "/");  # value is 4</font></pre>
  
      <p class="docText">The <tt><font color="#cc0000">rindex</font></tt>
function also has an optional third parameter, but in this case it effectively
gives the <span class="docEmphasis">maximum</span> permitted return value: 
      </p>
  
      <pre><font color="#cc0000">my $fred = "Yabba dabba doo!";<br>my $where1 = rindex($fred, "abba");  # $where1 gets 7<br>my $where2 = rindex($fred, "abba", $where1 - 1);  # $where2 gets 1<br>my $where3 = rindex($fred, "abba", $where2 - 1);  # $where3 gets -1</font></pre>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-15-SECT-2"></a> 
      <h3 class="docSection1Title">15.2 Manipulating a Substring with substr</h3>
  
      <p class="docText">The <tt><font color="#cc0000">substr</font></tt><a
 name="IXT-15-336546"></a> operator works with only a part of a larger string.
It looks like this: </p>
  
      <pre><font color="#cc0000">$part = substr($string, $initial_position, $length);</font></pre>
  
      <p class="docText">It takes three arguments: a string value, a zero-based
initial position (like the return value of <tt><font color="#cc0000">index</font></tt>),
and a length for the substring. The return value is the substring: </p>
  
      <pre><font color="#cc0000">my $mineral = substr("Fred J. Flintstone", 8, 5);  # gets "Flint"<br>my $rock = substr "Fred J. Flintstone", 13, 1000;  # gets "stone"</font></pre>
  
      <p class="docText">As you may have noticed in the previous example,
if the requested length (<tt><font color="#cc0000">1000</font></tt> characters,
in this case) would go past the end of the string, there's no complaint from
Perl, but you simply get a shorter string than you might have. But if you
want to be sure to go to the end of the string, however long or short it may
be, just omit that third parameter (the length), like this: </p>
  
      <pre><font color="#cc0000">my $pebble = substr "Fred J. Flintstone", 13;  # gets "stone"</font></pre>
  
      <p class="docText">The initial position of the substring in the larger
string can be negative, counting from the end of the string (that is, position 
      <tt><font color="#cc0000">-1</font></tt> is the last character).<sup
 class="docFootnote"><a class="docLink" href="#">[3]</a></sup> In this example,
position <tt><font color="#cc0000">-3</font></tt> is three characters from
the end of the string, which is the location of the letter <tt><font
 color="#cc0000">i</font></tt>: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[3]</a></sup> This is analogous
to what we saw with array indices in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-3#lperl3-CHP-3">Chapter 3</a>. Just
as arrays may be indexed either from <tt><font color="#cc0000">0</font></tt>
(the first element) upwards or from <tt><font color="#cc0000">-1</font></tt> 
(the last element) downwards, substring locations may be indexed from position
        <tt><font color="#cc0000">0</font></tt> (at the first character) upwards
or from position <tt><font color="#cc0000">-1</font></tt> (at the last character)
downwards.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my $out = substr("some very long string", -3, 2);  # $out gets "in"</font></pre>
  
      <p class="docText">As you might expect, <tt><font color="#cc0000">index</font></tt><a
 name="IXT-15-336547"></a> and <tt><font color="#cc0000">substr</font></tt>
work well together. In this example, we can extract a substring that starts
at the location of the letter <tt><font color="#cc0000">l</font></tt>: </p>
  
      <pre><font color="#cc0000">my $long = "some very very long string";<br>my $right = substr($long, index($long, "l") );</font></pre>
  
      <p class="docText">Now here's something really cool: The selected portion
of the string can be changed if the string is a variable:<sup
 class="docFootnote"><a class="docLink" href="#">[4]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[4]</a></sup> Well, technically,
it can be any <i>lvalue</i>. What that term means precisely is beyond the
scope of this book, but you can think of it as anything that can be put on
the left side of the equals sign (<tt><font color="#cc0000">=</font></tt>)
in a scalar assignment. That's usually a variable, but it can (as you see
here) even be an invocation of the <tt><font color="#cc0000">substr </font></tt>operator.
        </p>
      </blockquote>
  
      <pre><font color="#cc0000">my $string = "Hello, world!";<br>substr($string, 0, 5) = "Goodbye";  # $string is now "Goodbye, world!"</font></pre>
  
      <p class="docText">As you see, the assigned (sub)string doesn't have
to be the same length as the substring it's replacing. The string's length
is adjusted to fit. Or if that wasn't cool enough to impress you, you could
use the binding operator (<tt><font color="#cc0000">=~</font></tt>) to restrict
an operation to work with just part of a string. This example replaces <tt><font
 color="#cc0000">fred</font></tt> with <tt><font color="#cc0000">barney</font></tt>
wherever possible within just the last twenty characters of a string: </p>
  
      <pre><font color="#cc0000">substr($string, -20) =~ s/fred/barney/g;</font></pre>
  
      <p class="docText">To be completely honest, we've never actually needed
that functionality in any of our own code, and chances are that you'll never
need it either. But it's nice to know that Perl can do more than you'll ever
need, isn't it? </p>
  
      <p class="docText">Much of the work that <tt><font color="#cc0000">substr</font></tt>
and <tt><font color="#cc0000">index</font></tt> do could be done with regular
expressions. Use those where they're appropriate. But <tt><font
 color="#cc0000">substr</font></tt> and <tt><font color="#cc0000">index</font></tt>
can often be faster, since they don't have the overhead of the regular expression
engine: they're never case-insensitive, they have no metacharacters to worry
about, and they don't set any of the memory variables. </p>
  
      <p class="docText">Besides assigning to the <tt><font
 color="#cc0000">substr</font></tt> function (which looks a little weird
at first glance, perhaps), you can also use <tt><font color="#cc0000">substr</font></tt>
in a slightly more traditional manner<sup class="docFootnote"><a
 class="docLink" href="#">[5]</a></sup> with the four-argument version, in
which the fourth argument is the replacement substring: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[5]</a></sup> By traditional
we mean in the "function invocation" sense, but not the "Perl" sense, since 
this feature was introduced to Perl relatively recently.</p>
      </blockquote>
  
      <pre><font color="#cc0000">my $previous_value = substr($string, 0, 5, "Goodbye");</font></pre>
  
      <p class="docText">The previous value comes back as the return value,
although as always, you can use this function in a void context to simply
discard it.<a name="IXTR3-105"></a> </p>
   <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-15-SECT-3"></a> 
      <h3 class="docSection1Title">15.3 Formatting Data with sprintf</h3>
  
      <p class="docText"><i></i><a name="lperl3-IDXTERM-1000"></a> <a
 name="lperl3-IDXTERM-1001"></a>The <tt><font color="#cc0000">sprintf</font></tt>
function takes the same arguments as <tt><font color="#cc0000">printf</font></tt>
(except for the optional filehandle, of course), but it returns the requested
string instead of printing it. This is handy if you want to store a formatted
string into a variable for later use, or if you want more control over the
result than <tt><font color="#cc0000">printf</font></tt> alone would provide: 
      </p>
  
      <pre><font color="#cc0000">my $date_tag = sprintf<br>  "%4d/%02d/%02d %2d:%02d:%02d",<br>  $yr, $mo, $da, $h, $m, $s;</font></pre>
  
      <p class="docText">In that example, <tt><font color="#cc0000">$date_tag</font></tt>
gets something like <tt><font color="#cc0000">"2038/01/19 3:00:08"</font></tt>.
The format string (the first argument to <tt><font color="#cc0000">sprintf</font></tt>)
used a leading zero on some of the format number, which we didn't mention
when we talked about <tt><font color="#cc0000">printf</font></tt> formats
in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-6#lperl3-CHP-6">Chapter 6</a>. The
leading zero on the format number means to use leading zeroes as needed to
make the number as wide as requested. Without a leading zero in the formats,
the resulting date-and-time string would have unwanted leading spaces instead
of zeroes, looking like <tt><font color="#cc0000">"2038/ 1/19 3: 0: 8"</font></tt>. 
      </p>
  <a name="lperl3-CHP-15-SECT-3.1"></a> 
      <h4 class="docSection2Title">15.3.1 Using sprintf with "Money Numbers"</h4>
  
      <p class="docText"><a name="lperl3-IDXTERM-1002"></a> <a
 name="lperl3-IDXTERM-1003"></a> <a name="lperl3-IDXTERM-1004"></a>One popular
use for <tt><font color="#cc0000">sprintf</font></tt> is when a number needs
to be rendered with a certain number of places after the decimal point, such
as when an amount of money needs to be shown as <tt><font
 color="#cc0000">2.50</font></tt> and not <tt><font color="#cc0000">2.5</font></tt>&#8212;and
certainly not as <tt><font color="#cc0000">2.49997</font></tt>! That's easy
to accomplish with the <tt><font color="#cc0000">"%.2f"</font></tt> format: 
      </p>
  
      <pre><font color="#cc0000">my $money = sprintf "%.2f", 2.49997;</font></pre>
  
      <p class="docText">The full implications of rounding are numerous and
subtle, but in most cases you should keep numbers in memory with all of the 
available accuracy, rounding off only for output. </p>
  
      <p class="docText">If you have a "money number" that may be large enough
to need commas to show its size, you might find it handy to use a subroutine
like this one.<sup class="docFootnote"><a class="docLink" href="#">[6]</a></sup> 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[6]</a></sup> Yes, we know
that not everywhere in the world are commas used to separate groups of digits, 
not everywhere are the digits grouped by threes, and not everywhere the currency
symbol appears as it does for U.S. dollars. But this is a good example anyway,
so there!</p>
      </blockquote>
  
      <pre><font color="#cc0000">sub big_money {<br>  my $number = sprintf "%.2f", shift @_;<br>  # Add one comma each time through the do-nothing loop<br>  1 while $number =~ s/^(-?\d+)(\d\d\d)/$1,$2/;<br>  # Put the dollar sign in the right place<br>  $number =~ s/^(-?)/$1\$/;<br>  $number;<br>}</font></pre>
  
      <p class="docText">This subroutine uses some techniques you haven't
seen yet, but they logically follow from what we've shown you. The first
line of the subroutine formats the first (and only) parameter to have exactly
two digits after the decimal point. That is, if the parameter were the number
      <tt><font color="#cc0000">12345678.9</font></tt>, now our <tt><font
 color="#cc0000">$number</font></tt> is the string <tt><font
 color="#cc0000">"12345678.90"</font></tt>.  </p>
  
      <p class="docText">The next line of code uses a <tt><font
 color="#cc0000">while</font></tt><a name="IXT-15-336548"></a> modifier.
As we mentioned when we covered that modifier in <a class="docLink"
 href="?xmlid=0-596-00132-0/lperl3-CHP-10#lperl3-CHP-10">Chapter 10</a>,
that can always be rewritten as a traditional <tt><font color="#cc0000">while</font></tt>
loop: </p>
  
      <pre><font color="#cc0000">while ($number =~ s/^(-?\d+)(\d\d\d)/$1,$2/) {<br>  1;<br>}</font></pre>
  
      <p class="docText">What does that say to do? It says that, as long
as the substitution returns a true value (signifying success), the loop body
should run. But the loop body does nothing! That's okay with Perl, but it 
tells us that the purpose of that statement is to do the conditional expression
(the substitution), rather than the useless loop body. The value <tt><font
 color="#cc0000">1</font></tt> is traditionally used as this kind of a placeholder,
although any other value would be equally useful.<sup
 class="docFootnote"><a class="docLink" href="#">[7]</a></sup> This works
just as well as the loop above: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[7]</a></sup> Which is to
say, useless. By the way, in case you're wondering, Perl optimizes away the
constant expression so it doesn't even take up any runtime.</p>
      </blockquote>
  
      <pre><font color="#cc0000">'keep looping' while $number =~ s/^(-?\d+)(\d\d\d)/$1,$2/;</font></pre>
  
      <p class="docText">So, now we know that the substitution is the real
purpose of the loop. But what is the substitution doing? Remember that <tt><font
 color="#cc0000">$number</font></tt> will be some string like <tt><font
 color="#cc0000">"12345678.90"</font></tt> at this point. The pattern will 
match the first part of the string, but it can't get past the decimal point.
(Do you see why it can't?) Memory <tt><font color="#cc0000">$1</font></tt>
will get <tt><font color="#cc0000">"12345"</font></tt>, and <tt><font
 color="#cc0000">$2</font></tt> will get <tt><font color="#cc0000">"678"</font></tt>,
so the substitution will make <tt><font color="#cc0000">$number</font></tt>
into <tt><font color="#cc0000">"12345,678.90"</font></tt> (remember, it couldn't
match the decimal point, so the last part of the string is left untouched). 
      </p>
  
      <p class="docText">Do you see what the dash is doing near the start
of that pattern? (Hint: The dash is allowed at only one place in the string.) 
We'll tell you at the end of this section, in case you haven't figured it
out. </p>
  
      <p class="docText">We're not done with that substitution statement
yet. Since the substitution succeeded, the do-nothing loop goes back to try
again. This time, the pattern can't match anything from the comma onward,
so <tt><font color="#cc0000">$number</font></tt> becomes <tt><font
 color="#cc0000">"12,345,678.90"</font></tt>. The substitution thus adds
a comma to the number each time through the loop. </p>
  
      <p class="docText">Speaking of the loop, it's still not done. Since
the previous substitution was a success, we're back around the loop to try 
again. But this time, the pattern can't match at all, since it has to match
at least four digits at the start of the string, so now that is the end of
the loop. </p>
  
      <p class="docText">Why couldn't we have simply used the <tt><font
 color="#cc0000">/g</font></tt> modifier to do a "global" search-and-replace,
to save the trouble and confusion of the <tt><font color="#cc0000">1 while</font></tt>?
We couldn't use that because we're working backwards from the decimal point,
rather than forward from the start of the string. Putting the commas in a
number like this can't be done simply with the <tt><font color="#cc0000">s///g</font></tt>
substitution alone.<sup class="docFootnote"><a class="docLink" href="#">[8]</a></sup> 
      </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[8]</a></sup> At least, it
can't be done without some more-advanced regular expression techniques than
we've shown you so far. Those darn Perl developers keep making it harder
and harder to write Perl books that use the word "can't."</p>
      </blockquote>
  
      <p class="docText">So, did you figure out the dash? It's allowing for
a possible minus-sign at the start of the string. The next line of code makes 
the same allowance, putting the dollar-sign in the right place so that <tt><font
 color="#cc0000">$number</font></tt> is something like <tt><font
 color="#cc0000">"$12,345,678.90"</font></tt>, or perhaps <tt><font
 color="#cc0000">"-$12,345,678.90"</font></tt> if it's negative. Note that
the dollar sign isn't necessarily the first character in the string, or that
line would be a lot simpler. Finally, the last line of code returns our nicely
formatted "money number," ready to be printed in the annual<a
 name="IXTR3-106"></a> <a name="IXTR3-107"></a> <a name="IXTR3-108"></a> report.<i></i><a
 name="IXTR3-109"></a> <a name="IXTR3-110"></a>  </p>
    <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
<hr size="1"><br>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
 <tbody>
    <tr>
 <td valign="top"><a name="lperl3-CHP-15-SECT-4"></a> 
      <h3 class="docSection1Title">15.4 Advanced Sorting</h3>
  
      <p class="docText"><a name="lperl3-IDXTERM-1011"></a>Earlier, in <a
 class="docLink" href="?xmlid=0-596-00132-0/lperl3-CHP-3#lperl3-CHP-3">Chapter
3</a>, we showed that you could sort a list in ascending ASCIIbetical order
by using the builtin <tt><font color="#cc0000">sort</font></tt> operator.
What if you want a numeric sort? Or a case-insensitive sort? Or maybe you
want to sort items according to information stored in a hash. Well, Perl
lets you sort a list in whatever order you'd need; we'll see all of those 
examples by the end of the chapter. </p>
  
      <p class="docText"><i></i><a name="lperl3-IDXTERM-1012"></a>You'll
tell Perl what order you want by making a <i>sort-definition subroutine</i>,
or <i>sort subroutine</i> for short. Now, when you first hear the term "sort 
subroutine," if you've been through any computer science courses, visions
of bubble sort and shell sort and quick sort race through your head, and
you say, "No, never again!" Don't worry; it's not that bad. In fact, it's 
pretty simple. Perl already knows how to sort a list of items; it merely
doesn't know which order you want. So the sort-definition subroutine simply
tells it the order. </p>
  
      <p class="docText">Why is this necessary? Well, if you think about
it, sorting is putting a bunch of things in order by comparing them all.
Since you can't compare them all at once, you need to compare two at a time,
eventually using what you find out about each pair's order to put the whole
kit'n'caboodle in line. Perl already understands all of those steps <span
 class="docEmphasis">except</span> for the part about how you'd like to compare
the items, so that's all you have to write. </p>
  
      <p class="docText">This means that the sort subroutine doesn't need
to sort many items after all. It merely has to be able to compare two items.
If it can put two items in the proper order, Perl will be able to tell (by 
repeatedly consulting the sort subroutine) what order you want for your data. 
      </p>
  
      <p class="docText">The sort subroutine is defined like an ordinary
subroutine (well, almost). This routine will be called repeatedly, each time
checking on a pair of elements from the list to be sorted. </p>
  
      <p class="docText">Now, if you were writing a subroutine that's expecting
to get two parameters that need sorting, you might write something like this 
to start: </p>
  
      <pre><font color="#cc0000">sub any_sort_sub {  # It doesn't really work this way<br>  my($a, $b) = @_;  # Get and name the two parameters<br>  # start comparing $a and $b here<br>  ...<br>}</font></pre>
  
      <p class="docText">But the sort subroutine will be called again and
again, often hundreds or thousands of times. Declaring the variables <tt><font
 color="#cc0000">$a</font></tt> and <tt><font color="#cc0000">$b</font></tt>
and assigning them values at the top of the subroutine will take just a little
time, but multiply that by the thousands of times that the routine will be 
called, and you can see that it contributes significantly to the overall
execution speed. </p>
  
      <p class="docText">We don't do it like that. (In fact, if you did it
that way, it wouldn't work.) Instead, it is as if Perl has done this for
us, before our subroutine's code has even started.<sup
 class="docFootnote"><a class="docLink" href="#">[9]</a></sup> You'll really
write a sort subroutine without that first line; both <tt><font
 color="#cc0000">$a</font></tt> and <tt><font color="#cc0000">$b</font></tt>
have been assigned for you. When the sort subroutine starts running, <tt><font
 color="#cc0000">$a</font></tt> and <tt><font color="#cc0000">$b</font></tt>
are two elements from the original list. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[9]</a></sup> To be honest,
it's closer to being as if Perl has used <tt><font color="#cc0000">local($a,
$b) </font></tt>in a private block around the <tt><font color="#cc0000">sort
        </font></tt>invocation, because these variables are really globals
rather than lexical variables. (Unless you do something unusual, though,
you can't tell the difference inside the sort subroutine; you can pretend
these are <tt><font color="#cc0000">my</font></tt> variables. <tt><font
 color="#cc0000">use strict</font></tt> makes a special exception for these
two globals, so you don't need to declare them in any way.) This means that
if your program already has its own <tt><font color="#cc0000">$a</font></tt>
or <tt><font color="#cc0000">$b</font></tt>, you won't be able to access
those while Perl is sorting the list. Also, be sure to note that the two
items to be sorted are <span class="docEmphasis">not</span> passed in via
        <tt><font color="#cc0000">@_</font></tt> (unless you use a subroutine 
prototype, which we won't cover in this book, but see the documentation for
the full details). Inside the sort subroutine, just use <tt><font
 color="#cc0000">$a</font></tt> and <tt><font color="#cc0000">$b</font></tt>,
and try not to worry too much about where they came from. And as if that wasn't
enough, if there's a lexical <tt><font color="#cc0000">$a</font></tt> or
        <tt><font color="#cc0000">$b</font></tt> somewhere in scope, the
subroutine definition doesn't work either. Whew!</p>
      </blockquote>
  
      <p class="docText">The subroutine returns a coded value describing
how the elements compare (like C's <tt><font color="#cc0000">qsort(3)</font></tt>
does, but it's Perl's own internal sort implementation). If <tt><font
 color="#cc0000">$a</font></tt> should appear before <tt><font
 color="#cc0000">$b</font></tt> in the final list, the sort subroutine returns
      <tt><font color="#cc0000">-1</font></tt> to say so. If <tt><font
 color="#cc0000">$b</font></tt> should appear before <tt><font
 color="#cc0000">$a</font></tt>, it returns <tt><font color="#cc0000">1</font></tt>. 
      </p>
  
      <p class="docText">If the order of <tt><font color="#cc0000">$a</font></tt>
and <tt><font color="#cc0000">$b</font></tt> doesn't matter, the subroutine
returns <tt><font color="#cc0000">0</font></tt>. Why would it not matter?
Perhaps you're doing a case-insensitive sort and the two strings are <tt><font
 color="#cc0000">fred</font></tt> and <tt><font color="#cc0000">Fred</font></tt>.
Or perhaps you're doing a numeric sort, and the two numbers are equal. </p>
  
      <p class="docText">We could now write a numeric sort subroutine like
this:</p>
  
      <pre><font color="#cc0000">sub by_number {<br>  # a sort subroutine, expect $a and $b<br>  if ($a &lt; $b) { -1 } elsif ($a &gt; $b) { 1 } else { 0 }<br>}</font></pre>
  
      <p class="docText">To use the sort subroutine, just put its name (without
an ampersand) between the keyword <tt><font color="#cc0000">sort</font></tt>
and the list to be sorted. This example puts a numerically sorted list of
numbers into <tt><font color="#cc0000">@result</font></tt>: </p>
  
      <pre><font color="#cc0000">my @result = sort by_number @some_numbers;</font></pre>
  
      <p class="docText">We called the subroutine <tt><font
 color="#cc0000">by_number</font></tt> because that describes how it's sorting.
But more importantly, you can read the line of code that uses it with sort
as saying "sort by number," as you would in English. Many sort-subroutine
names begin with <tt><font color="#cc0000">by_</font></tt> to describe how
they sort. Or we could have called this one <tt><font color="#cc0000">numerically</font></tt>,
for a similar reason, but that's more typing and more chance to mess something
up. </p>
  
      <p class="docText">Notice that we don't have to do anything in the
sort subroutine to declare <tt><font color="#cc0000">$a</font></tt> and <tt><font
 color="#cc0000">$b</font></tt>, and to set their values&#8212;and if we did, the
subroutine wouldn't work right. We just let Perl set up <tt><font
 color="#cc0000">$a</font></tt> and <tt><font color="#cc0000">$b</font></tt>
for us, and so all we need to write is the comparison. </p>
  
      <p class="docText">In fact, we can make it even simpler (and more efficient).
Since this kind of three-way comparison is frequent, Perl has a convenient 
shortcut to use to write it. In this case, we use the <a
 name="IXT-15-336549"></a> <a name="IXT-15-336550"></a>spaceship operator 
(<tt><font color="#cc0000">&lt;=&gt;</font></tt>).<sup
 class="docFootnote"><a class="docLink" href="#">[10]</a></sup> This operator
compares two numbers and returns <tt><font color="#cc0000">-1</font></tt>,
      <tt><font color="#cc0000">0</font></tt>, or <tt><font
 color="#cc0000">1</font></tt> as needed to sort them numerically. So we
could have written that sort subroutine better, like this: </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[10]</a></sup> We call it
that because it looks like one of the Tie-fighters from <span
 class="docEmphasis">Star Wars</span><a name="IXT-15-336551"></a>. Well,
it looks like that to us, anyway.</p>
      </blockquote>
  
      <pre><font color="#cc0000">sub by_number { $a &lt;=&gt; $b }</font></pre>
  
      <p class="docText">Since the spaceship compares <a
 name="IXT-15-336552"></a>numbers, you may have guessed that there's a corresponding
      <a name="IXT-15-336553"></a> <a name="IXT-15-336554"></a>three-way
string-comparison operator: <tt><font color="#cc0000">cmp</font></tt>. These
two are easy to remember and keep straight. The spaceship has a family resemblance
to the numeric <a name="IXT-15-336555"></a> <a name="IXT-15-336556"></a>comparison 
operators like <tt><font color="#cc0000">&gt;=</font></tt>, but it's three 
characters long instead of two because it has three possible return values
instead of two. And <tt><font color="#cc0000">cmp</font></tt> has a family 
resemblance to the string comparison operators like <tt><font
 color="#cc0000">ge</font></tt>, but it's three characters long instead of
two because it <span class="docEmphasis">also</span> has three possible return 
values instead of two.<sup class="docFootnote"><a class="docLink"
 href="#">[11]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[11]</a></sup> This is no
accident. Larry does things like this on purpose, to make Perl easier to
learn and remember. Remember, he's a linguist at heart, so he's studied how
people think of languages.</p>
      </blockquote>
  
      <p class="docText">Of course, <tt><font color="#cc0000">cmp</font></tt>
by itself provides the same order as the default sort. You'd never need to
write this subroutine, which yields merely the default sort order:<sup
 class="docFootnote"><a class="docLink" href="#">[12]</a></sup> </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[12]</a></sup> You'd never
need to write this unless, of course, you were writing an introductory Perl
book and needed it for an example.</p>
      </blockquote>
  
      <pre><font color="#cc0000">sub ASCIIbetically { $a cmp $b }<br>my @strings = sort ASCIIbetically @any_strings;</font></pre>
  
      <p class="docText">But you can use <tt><font color="#cc0000">cmp</font></tt>
to build a more complex sort order, like a case-insensitive sort: </p>
  
      <pre><font color="#cc0000">sub case_insensitive { "\L$a" cmp "\L$b" }</font></pre>
  
      <p class="docText">In this case, we're comparing the string from <tt><font
 color="#cc0000">$a</font></tt> (forced to lowercase) against the string
from <tt><font color="#cc0000">$b</font></tt> (forced to lowercase), giving
a case-insensitive sort order. </p>
  
      <p class="docText">Note that we're not modifying the elements themselves; 
we're merely using their values. That's actually important: for efficiency
reasons, <tt><font color="#cc0000">$a</font></tt> and <tt><font
 color="#cc0000">$b</font></tt> aren't copies of the data items. They're
actually new, temporary aliases for elements of the original list, so if
we changed them we'd be mangling the original data. Don't do that&#8212;it's neither
supported nor recommended. </p>
  
      <p class="docText">When your sort subroutine is as simple as the ones
we show here (and most of the time, it is), you can make the code even simpler
yet, by replacing the name of the sort routine with the entire sort routine 
"in line," like so: </p>
  
      <pre><font color="#cc0000">my @numbers = sort { $a &lt;=&gt; $b } @some_numbers;</font></pre>
  
      <p class="docText">In fact, in modern Perl, you'll hardly ever see
a separate sort subroutine; you'll frequently find sort routines written
inline as we've done here. </p>
  
      <p class="docText">Suppose you want to sort in descending numeric order.
That's easy enough to do with the help of <tt><font color="#cc0000">reverse</font></tt><a
 name="IXT-15-336557"></a>: </p>
  
      <pre><font color="#cc0000">my @descending = reverse sort { $a &lt;=&gt; $b } @some_numbers;</font></pre>
  
      <p class="docText">But here's a neat trick. The comparison operators 
(<tt><font color="#cc0000">&lt;=&gt;</font></tt> and <tt><font
 color="#cc0000">cmp</font></tt>) are very nearsighted; that is, they can't
see which operand is <tt><font color="#cc0000">$a</font></tt> and which is
      <tt><font color="#cc0000">$b</font></tt>, but only which <span
 class="docEmphasis">value</span> is on the left and which is on the right.
So if <tt><font color="#cc0000">$a</font></tt> and <tt><font
 color="#cc0000">$b</font></tt> were to swap places, the comparison operator
would get the results backwards every time. That means that this is another
way to get a reversed numeric sort: </p>
  
      <pre><font color="#cc0000">my @descending = sort { $b &lt;=&gt; $a } @some_numbers;</font></pre>
  
      <p class="docText">You can (with a little practice) read this at a
glance. It's a descending-order comparison (because <tt><font
 color="#cc0000">$b</font></tt> comes before <tt><font color="#cc0000">$a</font></tt>,
which is descending order), and it's a numeric comparison (because it uses
the spaceship instead of <tt><font color="#cc0000">cmp</font></tt>). So,
it's sorting numbers in reverse order. </p>
  <a name="lperl3-CHP-15-SECT-4.1"></a> 
      <h4 class="docSection2Title">15.4.1 Sorting a Hash by Value</h4>
  
      <p class="docText"><a name="lperl3-IDXTERM-1022"></a>Once you've been
sorting lists happily for a while you'll run into a situation where you want
to sort a hash by value. For example, three of our characters went out bowling
last night, and we've got their bowling scores in the following hash. We
want to be able to print out the list in the proper order, with the game
winner at the top, so we want to sort the hash by <a
 name="IXT-15-336558"></a>score: </p>
  
      <pre><font color="#cc0000">my %score = ("barney" =&gt; 195, "fred" =&gt; 205, "dino" =&gt; 30);<br>my @winners = sort by_score keys %score;</font></pre>
  
      <p class="docText">Of course, we aren't really going to be able to
sort the hash by score; that's just a verbal shortcut. You can't sort a hash!
But when we've used <tt><font color="#cc0000">sort</font></tt> with hashes 
before now, we've been sorting the keys of the hash (in ASCIIbetical order).
Now, we're still going to be sorting the keys of the hash, but the order
is now defined by their corresponding values from the hash. In this case,
the result should be a list of our three characters' names, in order according
to their bowling scores. </p>
  
      <p class="docText">Writing this sort subroutine is fairly easy. What
we want is to use a numeric comparison on the scores, rather than the names.
That is, instead of comparing <tt><font color="#cc0000">$a</font></tt> and
      <tt><font color="#cc0000">$b</font></tt> (the players' names), we want
to compare <tt><font color="#cc0000">$score{$a}</font></tt> and <tt><font
 color="#cc0000">$score{$b}</font></tt> (their scores). If you think of it
that way, it almost writes itself, as in: </p>
  
      <pre><font color="#cc0000">sub by_score { $score{$b} &lt;=&gt; $score{$a} }</font></pre>
  
      <p class="docText">Let's step through this and see how it works. Let's 
imagine that the first time it's called, Perl has set <tt><font
 color="#cc0000">$a</font></tt> to <tt><font color="#cc0000">barney</font></tt>
and <tt><font color="#cc0000">$b</font></tt> to <tt><font
 color="#cc0000">fred</font></tt>. So the comparison is <tt><font
 color="#cc0000">$score{"fred"} &lt;=&gt; $score{"barney</font></tt>"}, which
(as we can see by consulting the hash) is <tt><font color="#cc0000">205 &lt;=&gt;
195</font></tt>. Remember, now, the spaceship is nearsighted, so when it
sees <tt><font color="#cc0000">205</font></tt> before <tt><font
 color="#cc0000">195</font></tt>, it says, in effect: "No, that's not the
right numeric order; <tt><font color="#cc0000">$b</font></tt> should come
before <tt><font color="#cc0000">$a</font></tt>." So it tells Perl that <tt><font
 color="#cc0000">fred</font></tt> should come before <tt><font
 color="#cc0000">barney</font></tt>. </p>
  
      <p class="docText">Maybe the next time the routine is called, <tt><font
 color="#cc0000">$a</font></tt> is <tt><font color="#cc0000">barney</font></tt>
again but <tt><font color="#cc0000">$b</font></tt> is now <tt><font
 color="#cc0000">dino</font></tt>. The nearsighted numeric comparison sees 
      <tt><font color="#cc0000">30 &lt;=&gt; 195</font></tt> this time, so
it reports that that they're in the right order; <tt><font
 color="#cc0000">$a</font></tt> does indeed sort in front of <tt><font
 color="#cc0000">$b</font></tt>. That is, <tt><font color="#cc0000">barney</font></tt>
comes before <tt><font color="#cc0000">dino</font></tt>. At this point, Perl
has enough information to put the list in order: <tt><font
 color="#cc0000">fred</font></tt> is the winner, then <tt><font
 color="#cc0000">barney</font></tt> in second place, then <tt><font
 color="#cc0000">dino</font></tt>. </p>
  
      <p class="docText">Why did the comparison use the <tt><font
 color="#cc0000">$score{$b}</font></tt> before the <tt><font
 color="#cc0000">$score{$a}</font></tt>, instead of the other way around? 
That's because we want bowling scores arranged in <span
 class="docEmphasis">descending</span> order, from the highest score of the 
winner down. So you can (again, after a little practice) read this one at
sight as well: <tt><font color="#cc0000">$score{$b} &lt;=&gt; $score{$a}</font></tt>
means to sort according to the scores, in reversed numeric order. </p>
   <a name="lperl3-CHP-15-SECT-4.2"></a> 
      <h4 class="docSection2Title">15.4.2 Sorting by Multiple Keys</h4>
  
      <p class="docText">We forgot to mention that there was a fourth player
bowling last night with the other three, so the hash really looked like this: 
      </p>
  
      <pre><font color="#cc0000">my %score = (<br>  "barney" =&gt; 195, "fred" =&gt; 205,<br>  "dino" =&gt; 30, "bamm-bamm" =&gt; 195,<br>);</font></pre>
  
      <p class="docText">Now, as you can see, <tt><font color="#cc0000">bamm-bamm</font></tt>
has the same score as <tt><font color="#cc0000">barney</font></tt>. So which
one will be first in the sorted list of players? There's no telling, because
the comparison operator (seeing the same score on both sides) will have to
return zero when checking those two. </p>
  
      <p class="docText">Maybe that doesn't matter, but we generally prefer
to have a well-defined sort. If several players have the same score, we want 
them to be together in the list, of course. But within that group, the names
should be in ASCIIbetical order. But how can we write the sort subroutine
to say that? Again, this turns out to be pretty easy: </p>
  
      <pre><font color="#cc0000">my @winners = sort by_score_and_name keys %score;<br><br>sub by_score_and_name {<br>  $score{$b} &lt;=&gt; $score{$a}  # by descending numeric score<br>    or<br>  $a cmp $b                  # ASCIIbetically by name<br>}</font></pre>
  
      <p class="docText">How does this work? Well, if the spaceship sees
two different scores, that's the comparison we want to use. It returns <tt><font
 color="#cc0000">-1</font></tt> or <tt><font color="#cc0000">1</font></tt>,
a true value, so the low-precedence short-circuit <tt><font
 color="#cc0000">or</font></tt> will mean that the rest of the expression
will be skipped, and the comparison we want is returned. (Remember, the short-circuit
      <tt><font color="#cc0000">or</font></tt> returns the last expression
evaluated.) But if the spaceship sees two identical scores, it returns <tt><font
 color="#cc0000">0</font></tt>, a false value, and thus the <tt><font
 color="#cc0000">cmp</font></tt> operator gets its turn at bat, returning
an appropriate ordering value considering the keys as strings. That is, if
the scores are the same, the string-order comparison breaks the tie. </p>
  
      <p class="docText">We know that when we use the <tt><font
 color="#cc0000">by_score_and_name</font></tt> sort subroutine like this,
it will never return <tt><font color="#cc0000">0</font></tt>. (Do you see
why it won't? The answer is in the footnote.<sup class="docFootnote"><a
 class="docLink" href="#">[13]</a></sup>) So we know that the sort order
is always well-defined; that is, we know that the result today will be the
same as the result with the same data tomorrow. </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[13]</a></sup> The only way
it could return <tt><font color="#cc0000">0</font></tt> would be if the two
strings were identical, and (since the strings are keys of a hash) we already
know that they're different. Of course, if you passed a list with duplicate
(identical) strings to <tt><font color="#cc0000">sort</font></tt>, it would 
return <tt><font color="#cc0000">0</font></tt> when comparing those, but
we're passing a list of hash keys.</p>
      </blockquote>
  
      <p class="docText">There's no reason that your sort subroutine has
to be limited to two levels of sorting, of course. Here the Bedrock library
program puts a list of patron ID numbers in order according to a five-level 
sort.<sup class="docFootnote"><a class="docLink" href="#">[14]</a></sup>
This example sorts according to the amount of each patron's outstanding fines
(as calculated by a subroutine <tt><font color="#cc0000">&amp;fines</font></tt>,
not shown here), the number of items they currently have checked out (from 
      <tt><font color="#cc0000">%items</font></tt>), their name (in order
by family name, then by personal name, both from hashes), and finally by
the patron's ID number, in case everything else is the<a
 name="IXTR3-111"></a> same<i></i><a name="IXTR3-112"></a>:  </p>
 
      <blockquote>
        <p class="docFootnote"><sup><a name="">[14]</a></sup> It's not unusual
in the modern world to need a five-level sort like this, although it was
quite infrequent in prehistoric times.</p>
      </blockquote>
  
      <pre><font color="#cc0000">@patron_IDs = sort {<br>  &amp;fines($b) &lt;=&gt; &amp;fines($a) or<br>  $items{$b} &lt;=&gt; $items{$a} or<br>  $family_name{$a} cmp $family_name{$a} or<br>  $personal_name{$a} cmp $family_name{$b} or<br>  $a &lt;=&gt; $b<br>} @patron_IDs;</font></pre>
    <a href="?xmlid=0-596-00132-0/18961533"><img src="images/pixel.gif"
 width="1" height="1" border="0">
      </a>
      <ul>
      </ul>
 </td>
 </tr>
 
  </tbody>
</table>
  <a href="perl1.html">page 1</a><br>
 <a href="perl2.html">page 2</a><br>
 <a href="perl3.html">page 3</a><br>
 <a href="perl4.html">page 4</a><br>
   <br>
</body>
</html>
